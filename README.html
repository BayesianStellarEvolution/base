<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-06-02 Sun 14:42 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BASE-9</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Elliot Robinson" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">BASE-9</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb513257">1. BASE library</a>
<ul>
<li><a href="#org14cc19d">1.1. Types of numbers</a>
<ul>
<li><a href="#org3052e50">1.1.1. Positive numbers</a></li>
<li><a href="#org3640d68">1.1.2. The closed unit interval</a></li>
<li><a href="#orgf566420">1.1.3. Percentages</a></li>
<li><a href="#org30ebe5f">1.1.4. Non-negative numbers</a></li>
<li><a href="#org8e5f3a4">1.1.5. Logarithmic numbers</a></li>
<li><a href="#org3f87a19">1.1.6. Artifacts</a></li>
</ul>
</li>
<li><a href="#org5ebe485">1.2. Astrophysical types</a>
<ul>
<li><a href="#org6366d85">1.2.1. Tests</a></li>
<li><a href="#org94f3011">1.2.2. Artifacts</a></li>
</ul>
</li>
<li><a href="#org91770f0">1.3. Load compressed models</a></li>
<li><a href="#org83455f5">1.4. Model interpolation</a></li>
<li><a href="#orga2d676a">1.5. Example model input and expected internal representations</a></li>
<li><a href="#org0911221">1.6. <code>makeIsochrone</code> tool</a></li>
<li><a href="#org6e0db43">1.7. Benchmark</a></li>
<li><a href="#org22ca289">1.8. Artifacts</a>
<ul>
<li><a href="#org23fe10c">1.8.1. Cabal config</a></li>
<li><a href="#org16b3e0b">1.8.2. Test spec finder</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org98bb1c8">2. Photometric Model library</a>
<ul>
<li><a href="#org1e40c85">2.1. Artifacts</a></li>
</ul>
</li>
<li><a href="#org098841d">3. Global Artifacts</a>
<ul>
<li><a href="#org327f546">3.1. Stack config</a></li>
<li><a href="#orge834616">3.2. GitHub README</a></li>
</ul>
</li>
<li><a href="#orgea26e35">4. Templates</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgb513257" class="outline-2">
<h2 id="orgb513257"><span class="section-number-2">1.</span> BASE library</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org14cc19d" class="outline-3">
<h3 id="org14cc19d"><span class="section-number-3">1.1.</span> Types of numbers</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Poor management of logarithms, particularly when combining logarithms of unlike base, has been the cause of many bugs in prior BASE-9 work. For this reason, we first build a strong system of mathematical types, starting from definition of intervals and working to definitions for each base of logarithm supported.
</p>

<p>
Two characteristics are simultaneously desired for this utility: speed and correctness. 
</p>

<p>
At runtime, this domain-specific language (DSL) must be as free as possible, making maximum utilization of type erasure and rewrite rules ( TODO ). From the developer perspective, non-free operations should be noted.
</p>

<p>
At compile time, correctness should be provable in three ways:
</p>

<ol class="org-ol">
<li>no improper conversions or operations between incompatible types must be present (or the code won't compile),</li>
<li>the correct function of the conversions and operations between compatible types must be checked (via QuickCheck &amp;c. tests)</li>
<li>the mathematical validity of the conversions and operations between compatible types must be proven</li>
</ol>

<p>
This last point bears some further explanation. LiquidHaskell (LH) is a refinement type engine for Haskell programs that converts its domain-specific markup language, rendered as regular Haskell comments, and any associated Haskell code into a set of logical propositions for output to Z3, a SMT/SAT solver. This allows checking at compile time that some invariables are true, e.g, that some function shall never have a non-positive value as its second argument. Where necessary (e.g, functions provided by a library, where the code cannot be inspected by LiquidHaskell), LiquidHaskell is told to <code>assume</code> certain axioms (the proofs for which are up to the specifier).
</p>
</div>

<div id="outline-container-org3052e50" class="outline-4">
<h4 id="org3052e50"><span class="section-number-4">1.1.1.</span> Positive numbers</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
We first define a set of LH types that simplify the syntax for constraining values. The first of these is <code>GT</code> (for "Greater Than"), which is a type with one variable <code>N</code>. This is used as, <code>GT 0</code>, to specify that any value of that type must be greater than zero. This is specified thusly:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-@ type GT N = {v:Double | v &gt; N} @-}</span>
</pre>
</div>

<p>
This type states that, given some defined <code>N</code>, the Haskell type being refined by <code>GT</code> is a <code>Double</code> iff. the value of the variable represented by that type is always \(>0\) (otherwise, it is <code>Void</code> and the theorem doesn't hold, triggering a LH error). You can think of this as a type synonym in a dependently typed language, where this type not only defines the type of value it will contain (a <code>Double</code>), but also the range of valid values which may be contained by a concrete example of that type (Footnote: Proving that the value will always be in the valid range is the difficult step here).
</p>

<p>
See the "Artifacts" section for a complete listing of all the LH refinement helpers.
</p>

<p>
As a motivating example, this can be used to create a type that must always be positive:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-@ type PositiveR = GT 0 @-}</span>
</pre>
</div>

<p>
Note that this is still a refinement type in the LH type space (hence the final 'R'), not a type in the Haskell type space. We can use that to define a refined Haskell type:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-@ newtype Positive = MkPositive ( unPositive :: PositiveR) @-}</span>
<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">Positive</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkPositive</span> <span style="color: #707183;">{</span> unPositive <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
The new newtype, <code>Positive</code>, from Haskell's perspective, will store a single <code>Double</code>; however, due to the type annotation, to LiquidHaskell, it stores a PositiveR. What remains is to prove that to LH.
</p>

<p>
For this and each of the following classes of numbers, I will define three ways to create a value of the class. A non-annotated version that returns a <code>Maybe</code> to account for the possibility of failure, a "prime" version annotated with a single quote that throws an exception if the founds check fails, and an unsafe version that simply wraps the passed value (for performance) and relies on LH for verification of correctness.
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #006699;">positive</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Maybe</span> <span style="color: #6434A3;">Positive</span>
<span style="color: #006699;">positive</span> f <span style="color: #BA36A5;">|</span> f <span style="color: #BA36A5;">&gt;</span> 0     <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Just</span> <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">MkPositive</span> f
           <span style="color: #BA36A5;">|</span> otherwise <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Nothing</span>


<span style="color: #0000FF;">data</span> <span style="color: #6434A3;">PositiveBoundsException</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">PositiveBoundsException</span>
     <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Exception</span> <span style="color: #6434A3;">PositiveBoundsException</span>

<span style="color: #006699;">positive'</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Positive</span>
<span style="color: #006699;">positive'</span> f <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">if</span> f <span style="color: #BA36A5;">&gt;</span> 0
                 <span style="color: #0000FF;">then</span> <span style="color: #6434A3;">MkPositive</span> f
                 <span style="color: #0000FF;">else</span> throw <span style="color: #6434A3;">PositiveBoundsException</span>


<span style="color: #808080;">{-@ positive_unsafe :: PositiveR -&gt; Positive @-}</span>
<span style="color: #006699;">positive_unsafe</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Positive</span>
<span style="color: #006699;">positive_unsafe</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkPositive</span>
</pre>
</div>

<p>
The implementations are straight forward. Note that, other than the unsafe version (which adds a refinement to its first parameter), no additional LH annotation is needed. LH integrates the AST for the Haskell code into the proof, notes the check for <code>f &gt; 0</code>, and uses that to satisfy the <code>GT 0</code> refinement.
</p>

<p>
In order to more easily run QuickCheck tests in which <code>Positive</code> values are used, an <code>Arbitrary</code> instance is provided. <code>chooseAny</code> provides any random value meeting the type constraint (<code>Double</code>, via <code>MkPositive</code>), which we then constrain to meet our requirement. That \(0\) will be chosen is a veritable guarantee; as it is not positive, we add the the minimum possible value allowed by the <code>Double</code> (a unit of least precision [ULP]).
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Arbitrary</span> <span style="color: #6434A3;">Positive</span> <span style="color: #0000FF;">where</span>
  arbitrary <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span> val <span style="color: #BA36A5;">&lt;-</span> abs <span style="color: #BA36A5;">&lt;$&gt;</span> chooseAny
                 return <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">if</span> val <span style="color: #BA36A5;">==</span> 0
                             <span style="color: #0000FF;">then</span> <span style="color: #6434A3;">MkPositive</span> <span style="color: #707183;">(</span>addUlps 1 val<span style="color: #707183;">)</span>
                             <span style="color: #0000FF;">else</span> <span style="color: #6434A3;">MkPositive</span> val
</pre>
</div>

<p>
Where relevant, future sections proceed as with this one, minus the explanatory prose.
</p>
</div>
</div>

<div id="outline-container-org3640d68" class="outline-4">
<h4 id="org3640d68"><span class="section-number-4">1.1.2.</span> The closed unit interval</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
The Closed Unit Interval is any number \(0<=x<=1\).
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-@ type ClosedUnitIntervalR = Btwn 0 1 @-}</span>
<span style="color: #808080;">{-@ newtype ClosedUnitInterval = MkClosedUnitInterval { unClosedUnitInterval :: ClosedUnitIntervalR} @-}</span>
<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">ClosedUnitInterval</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkClosedUnitInterval</span> <span style="color: #707183;">{</span> unClosedUnitInterval <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Read</span>, <span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>


<span style="color: #006699;">closedUnitInterval</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Maybe</span> <span style="color: #6434A3;">ClosedUnitInterval</span>
<span style="color: #006699;">closedUnitInterval</span> f <span style="color: #BA36A5;">|</span> f <span style="color: #BA36A5;">&gt;=</span> 0 <span style="color: #BA36A5;">&amp;&amp;</span> f <span style="color: #BA36A5;">&lt;=</span> 1 <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Just</span> <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">MkClosedUnitInterval</span> f
                     <span style="color: #BA36A5;">|</span> otherwise        <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Nothing</span>


<span style="color: #0000FF;">data</span> <span style="color: #6434A3;">ClosedUnitIntervalBoundsException</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">ClosedUnitIntervalBoundsException</span>
     <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Exception</span> <span style="color: #6434A3;">ClosedUnitIntervalBoundsException</span>

<span style="color: #006699;">closedUnitInterval'</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">ClosedUnitInterval</span>
<span style="color: #006699;">closedUnitInterval'</span> f <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">if</span> 0 <span style="color: #BA36A5;">&lt;=</span> f <span style="color: #BA36A5;">&amp;&amp;</span> f <span style="color: #BA36A5;">&lt;=</span> 1
                           <span style="color: #0000FF;">then</span> <span style="color: #6434A3;">MkClosedUnitInterval</span> f
                           <span style="color: #0000FF;">else</span> throw <span style="color: #6434A3;">ClosedUnitIntervalBoundsException</span>


<span style="color: #808080;">{-@ closedUnitInterval_unsafe :: ClosedUnitIntervalR -&gt; ClosedUnitInterval @-}</span>
<span style="color: #006699;">closedUnitInterval_unsafe</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">ClosedUnitInterval</span>
<span style="color: #006699;">closedUnitInterval_unsafe</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkClosedUnitInterval</span>


<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Arbitrary</span> <span style="color: #6434A3;">ClosedUnitInterval</span> <span style="color: #0000FF;">where</span>
  arbitrary <span style="color: #BA36A5;">=</span> choose <span style="color: #707183;">(</span>0, 1<span style="color: #707183;">)</span> <span style="color: #BA36A5;">&gt;&gt;=</span> return <span style="color: #BA36A5;">.</span> <span style="color: #6434A3;">MkClosedUnitInterval</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf566420" class="outline-4">
<h4 id="orgf566420"><span class="section-number-4">1.1.3.</span> Percentages</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
Percentages are closed unit intervals with additional meaning, namely that they represent a "real world" proportion (e.g., helium fraction) rather something that may only exist in code (interpolation fraction).
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">Percentage</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkPercentage</span> <span style="color: #707183;">{</span> unPercentage <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">ClosedUnitInterval</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Read</span>, <span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org30ebe5f" class="outline-4">
<h4 id="org30ebe5f"><span class="section-number-4">1.1.4.</span> Non-negative numbers</h4>
<div class="outline-text-4" id="text-1-1-4">
<p>
Non-negative numbers are those where \(0<=x\).
</p>

<p>
Non-negative numbers have the distinction of being the type of number for which a logarithm may be calculated without receiving <code>NaN</code>, or "not a number". Due to this, this is the only type of number that currently defines <code>Num</code> and <code>Unbox</code> (for performance).
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-@ type NonNegativeR = GTE 0 @-}</span>
<span style="color: #808080;">{-@ newtype NonNegative = MkNonNegative { unNonNegative :: NonNegativeR } @-}</span>
<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkNonNegative</span> <span style="color: #707183;">{</span> unNonNegative <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Num</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #0000FF;">where</span>
  <span style="color: #707183;">(</span><span style="color: #BA36A5;">+</span><span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">MkNonNegative</span> a<span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">MkNonNegative</span> b<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkNonNegative</span> <span style="color: #BA36A5;">$</span> a <span style="color: #BA36A5;">+</span> b
  <span style="color: #707183;">(</span><span style="color: #BA36A5;">-</span><span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">MkNonNegative</span> a<span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">MkNonNegative</span> b<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> nonNegative'  <span style="color: #BA36A5;">$</span> a <span style="color: #BA36A5;">-</span> b
  <span style="color: #707183;">(</span><span style="color: #BA36A5;">*</span><span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">MkNonNegative</span> a<span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">MkNonNegative</span> b<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkNonNegative</span> <span style="color: #BA36A5;">$</span> a <span style="color: #BA36A5;">*</span> b
  abs <span style="color: #BA36A5;">=</span> id
  signum <span style="color: #BA36A5;">=</span> const 0
  fromInteger <span style="color: #BA36A5;">=</span> nonNegative' <span style="color: #BA36A5;">.</span> realToFrac
  negate <span style="color: #0000FF;">_</span> <span style="color: #BA36A5;">=</span> throw <span style="color: #6434A3;">NonNegativeBoundsException</span>


<span style="color: #006699;">nonNegative</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Maybe</span> <span style="color: #6434A3;">NonNegative</span>
<span style="color: #006699;">nonNegative</span> f <span style="color: #BA36A5;">|</span> f <span style="color: #BA36A5;">&gt;=</span> 0    <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Just</span> <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">MkNonNegative</span> f
              <span style="color: #BA36A5;">|</span> otherwise <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Nothing</span>


<span style="color: #0000FF;">data</span> <span style="color: #6434A3;">NonNegativeBoundsException</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">NonNegativeBoundsException</span>
     <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Exception</span> <span style="color: #6434A3;">NonNegativeBoundsException</span>

<span style="color: #006699;">nonNegative'</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">NonNegative</span>
<span style="color: #006699;">nonNegative'</span> f <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">if</span> f <span style="color: #BA36A5;">&gt;=</span> 0.0
                    <span style="color: #0000FF;">then</span> <span style="color: #6434A3;">MkNonNegative</span> f
                    <span style="color: #0000FF;">else</span> throw <span style="color: #6434A3;">NonNegativeBoundsException</span>


<span style="color: #808080;">{-@ nonNegative_unsafe :: NonNegativeR -&gt; NonNegative @-}</span>
<span style="color: #006699;">nonNegative_unsafe</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">NonNegative</span>
<span style="color: #006699;">nonNegative_unsafe</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkNonNegative</span>


<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Arbitrary</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #0000FF;">where</span>
  arbitrary <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkNonNegative</span> <span style="color: #BA36A5;">.</span> abs <span style="color: #BA36A5;">&lt;$&gt;</span> chooseAny


<span style="color: #006699;">derivingUnbox</span> <span style="color: #008000;">"NonNegative"</span>
  <span style="color: #707183;">[</span>t<span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>
  <span style="color: #707183;">[</span><span style="color: #BA36A5;">|</span> unNonNegative <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>
  <span style="color: #707183;">[</span><span style="color: #BA36A5;">|</span> nonNegative'  <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8e5f3a4" class="outline-4">
<h4 id="org8e5f3a4"><span class="section-number-4">1.1.5.</span> Logarithmic numbers</h4>
<div class="outline-text-4" id="text-1-1-5">
<p>
Now, to the point of this exercise. First, we define some basic operations for working with any values in a logarithmic space (vs. linear). Each base (described later) will be an instance of this class.
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">class</span> <span style="color: #6434A3;">LogSpace</span> a <span style="color: #0000FF;">where</span>
  toLogSpace   <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #036A07;">-- ^ Take any non-negative number and express it as a value in log_N space</span>
  fromLogSpace <span style="color: #BA36A5;">::</span> a <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #036A07;">-- ^ Return a number to non-log space</span>
  packLog   <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #036A07;">-- ^ Encode a value already in log space as a LogSpace a</span>
  unpackLog <span style="color: #BA36A5;">::</span> a <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Double</span> <span style="color: #036A07;">-- ^ Access the raw log value directly</span>
</pre>
</div>

<p>
For example, to convert the number 1 to its base-10 log equivalent, you would
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #707183;">(</span>toLogSpace <span style="color: #BA36A5;">$</span> nonNegative' 1<span style="color: #707183;">)</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log10</span>
</pre>
</div>

<p>
And to inject a NaN,
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #707183;">(</span>packLog <span style="color: #BA36A5;">$</span> log <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">-</span>1<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log10</span>
</pre>
</div>

<p>
Note here that the use of <code>log</code> to create a <code>Log10</code> value is not suspect because <code>NaN</code> is just a <code>Double</code>; however, also note that this code will (quite properly) not pass the LH constraints that require the input to <code>log</code> to be \(0<=x\).
</p>
</div>

<ol class="org-ol">
<li><a id="org75cc5c6"></a>Natural<br />
<div class="outline-text-5" id="text-1-1-5-1">
<p>
We will model each logarithmic base in use (natural, 10, 2, solar mass?) as its own data type. This leads to some redundancy but maximizes type safety. As performance is of primary concern, effort is made to use newtypes and minimize use of checked conversions.
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">NaturalLog</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkNaturalLog</span> <span style="color: #707183;">{</span> unNaturalLog <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Read</span>, <span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>

<span style="color: #006699;">toNaturalLogSpace</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">NaturalLog</span>
<span style="color: #006699;">toNaturalLogSpace</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkNaturalLog</span> <span style="color: #BA36A5;">.</span> log <span style="color: #BA36A5;">.</span> coerce

<span style="color: #006699;">fromNaturalLogSpace</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">NaturalLog</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">NonNegative</span>
<span style="color: #006699;">fromNaturalLogSpace</span> <span style="color: #BA36A5;">=</span> nonNegative_unsafe <span style="color: #BA36A5;">.</span> exp <span style="color: #BA36A5;">.</span> coerce

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">LogSpace</span> <span style="color: #6434A3;">NaturalLog</span> <span style="color: #0000FF;">where</span>
  toLogSpace   <span style="color: #BA36A5;">=</span> toNaturalLogSpace
  fromLogSpace <span style="color: #BA36A5;">=</span> fromNaturalLogSpace
  packLog <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkNaturalLog</span>
  unpackLog <span style="color: #BA36A5;">=</span> unNaturalLog

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Arbitrary</span> <span style="color: #6434A3;">NaturalLog</span> <span style="color: #0000FF;">where</span>
  arbitrary <span style="color: #BA36A5;">=</span> toLogSpace <span style="color: #BA36A5;">&lt;$&gt;</span> arbitrary
</pre>
</div>
</div>
</li>

<li><a id="org3117fbd"></a>Base 10<br />
<div class="outline-text-5" id="text-1-1-5-2">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">Log10</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkLog10</span> <span style="color: #707183;">{</span> unLog10 <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Read</span>, <span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>

<span style="color: #006699;">toLog10Space</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Log10</span>
<span style="color: #006699;">toLog10Space</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkLog10</span> <span style="color: #BA36A5;">.</span> logBase 10 <span style="color: #BA36A5;">.</span> coerce

<span style="color: #006699;">fromLog10Space</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log10</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">NonNegative</span>
<span style="color: #006699;">fromLog10Space</span> <span style="color: #BA36A5;">=</span> nonNegative_unsafe <span style="color: #BA36A5;">.</span> <span style="color: #707183;">(</span>10 <span style="color: #BA36A5;">**</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">.</span> coerce

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">LogSpace</span> <span style="color: #6434A3;">Log10</span> <span style="color: #0000FF;">where</span>
  toLogSpace   <span style="color: #BA36A5;">=</span> toLog10Space
  fromLogSpace <span style="color: #BA36A5;">=</span> fromLog10Space
  packLog <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkLog10</span>
  unpackLog <span style="color: #BA36A5;">=</span> unLog10

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Arbitrary</span> <span style="color: #6434A3;">Log10</span> <span style="color: #0000FF;">where</span>
  arbitrary <span style="color: #BA36A5;">=</span> toLogSpace <span style="color: #BA36A5;">&lt;$&gt;</span> arbitrary

<span style="color: #006699;">derivingUnbox</span> <span style="color: #008000;">"Log10"</span>
  <span style="color: #707183;">[</span>t<span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">Log10</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>
  <span style="color: #707183;">[</span><span style="color: #BA36A5;">|</span> unLog10 <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>
  <span style="color: #707183;">[</span><span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">MkLog10</span> <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>
</pre>
</div>
</div>
</li>

<li><a id="orgc2598ce"></a>Base 2<br />
<div class="outline-text-5" id="text-1-1-5-3">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">Log2</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkLog2</span> <span style="color: #707183;">{</span> unLog2 <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Read</span>, <span style="color: #6434A3;">Show</span> , <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>

<span style="color: #006699;">toLog2Space</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Log2</span>
<span style="color: #006699;">toLog2Space</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkLog2</span> <span style="color: #BA36A5;">.</span> logBase 2 <span style="color: #BA36A5;">.</span> coerce

<span style="color: #006699;">fromLog2Space</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log2</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">NonNegative</span>
<span style="color: #006699;">fromLog2Space</span> <span style="color: #BA36A5;">=</span> nonNegative_unsafe <span style="color: #BA36A5;">.</span> <span style="color: #707183;">(</span>2 <span style="color: #BA36A5;">**</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">.</span> coerce

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">LogSpace</span> <span style="color: #6434A3;">Log2</span> <span style="color: #0000FF;">where</span>
  toLogSpace   <span style="color: #BA36A5;">=</span> toLog2Space
  fromLogSpace <span style="color: #BA36A5;">=</span> fromLog2Space
  packLog <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkLog2</span>
  unpackLog <span style="color: #BA36A5;">=</span> unLog2

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Arbitrary</span> <span style="color: #6434A3;">Log2</span> <span style="color: #0000FF;">where</span>
  arbitrary <span style="color: #BA36A5;">=</span> toLogSpace <span style="color: #BA36A5;">&lt;$&gt;</span> arbitrary
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org3f87a19" class="outline-4">
<h4 id="org3f87a19"><span class="section-number-4">1.1.6.</span> Artifacts</h4>
<div class="outline-text-4" id="text-1-1-6">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# LANGUAGE TemplateHaskell, TypeFamilies, MultiParamTypeClasses #-}</span>
<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Types.Internal</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">ClosedUnitInterval</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
                      ,closedUnitInterval
                      ,closedUnitInterval'
                      ,closedUnitInterval_unsafe
                      ,<span style="color: #6434A3;">Positive</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
                      ,positive
                      ,positive'
                      ,positive_unsafe
                      ,<span style="color: #6434A3;">NonNegative</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
                      ,nonNegative
                      ,nonNegative'
                      ,nonNegative_unsafe
                      ,<span style="color: #6434A3;">LogSpace</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
                      ,<span style="color: #6434A3;">NaturalLog</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
                      ,<span style="color: #6434A3;">Log2</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
                      ,<span style="color: #6434A3;">Log10</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
                      ,<span style="color: #6434A3;">Percentage</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Control.Exception</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Exception</span>, throw<span style="color: #707183;">)</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Coerce</span> <span style="color: #707183;">(</span>coerce<span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Vector.Unboxed.Deriving</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Test.QuickCheck</span>     <span style="color: #707183;">(</span><span style="color: #6434A3;">Arbitrary</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Test.QuickCheck.Gen</span> <span style="color: #707183;">(</span>choose, chooseAny<span style="color: #707183;">)</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Numeric.MathFunctions.Comparison</span> <span style="color: #707183;">(</span>addUlps<span style="color: #707183;">)</span>


<span style="color: #808080;">{-@ type GT N = {v:Double | v &gt; N} @-}</span>
<span style="color: #808080;">{-@ type GTE N = {v:Double | v &gt;= N} @-}</span>
<span style="color: #808080;">{-@ type LT  N = {v:Double | v &lt;  N} @-}</span>
<span style="color: #808080;">{-@ type LTE N = {v:Double | v &lt;= N} @-}</span>
<span style="color: #808080;">{-@ type Btwn LO HI = {v:Double | (LO &lt;= v) &amp;&amp; (v &lt;= HI)} @-}</span>


<span style="color: #808080;">{-@ assume abs :: _ -&gt; {v:_ | 0 &lt;= v} @-}</span>
<span style="color: #808080;">{-@ assume choose :: System.Random.Random a =&gt; t:(a, a) -&gt; Test.QuickCheck.Gen {v:a | (v &gt;= fst t) &amp;&amp; (v &lt;= snd t)} @-}</span>
<span style="color: #808080;">{-@ assume addUlps :: {u:Int | u &gt; 0} -&gt; v:Double -&gt; {r:Double | r &gt; v} @-}</span>
<span style="color: #808080;">{-@ assume log :: Floating a =&gt; {v:a | v &gt;= 0} -&gt; a @-}</span>
<span style="color: #808080;">{-@ assume exp :: Floating a =&gt; a -&gt; {v:a | v &gt;= 0} @-}</span>
<span style="color: #808080;">{-@ assume logBase :: Floating a =&gt; {base:a | base &gt;= 0} -&gt; {v:a | v &gt;= 0} -&gt; a @-}</span>
<span style="color: #808080;">{-@ assume GHC.Float.** :: Floating a =&gt; {base:a | base &gt;= 0} -&gt; a -&gt; {v:a | v &gt;= 0} @-}</span>
<span style="color: #808080;">{-@ assume GHC.Float.pi :: Floating a =&gt; {v:a | v &gt; 3.141592 &amp;&amp; v &lt; 3.141593} @-}</span>


<span style="color: #BA36A5;">&lt;&lt;</span>number <span style="color: #0000FF;">class</span><span style="color: #BA36A5;">&gt;&gt;</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5ebe485" class="outline-3">
<h3 id="org5ebe485"><span class="section-number-3">1.2.</span> Astrophysical types</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">FeH</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkFeH</span> <span style="color: #707183;">{</span> unFeH <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log10</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Read</span>, <span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>


<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">HeliumFraction</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkHeliumFraction</span> <span style="color: #707183;">{</span> unHeliumFraction <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Percentage</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Read</span>, <span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>


<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">CarbonFraction</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkCarbonFraction</span> <span style="color: #707183;">{</span> unCarbonFraction <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Percentage</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>


<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">Mass</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkMass</span> <span style="color: #707183;">{</span> unMass <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>

<span style="color: #006699;">derivingUnbox</span> <span style="color: #008000;">"Mass"</span>
  <span style="color: #707183;">[</span>t<span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">Mass</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>
  <span style="color: #707183;">[</span><span style="color: #BA36A5;">|</span> unMass <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>
  <span style="color: #707183;">[</span><span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">MkMass</span> <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>


<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">LogAge</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkLogAge</span> <span style="color: #707183;">{</span> unLogAge <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log10</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Read</span>, <span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>


<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">TotalAge</span>   <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkTotalAge</span>   <span style="color: #707183;">{</span>   unTotalAge <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">LogAge</span> <span style="color: #707183;">}</span>
<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">CoolingAge</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkCoolingAge</span> <span style="color: #707183;">{</span> unCoolingAge <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">LogAge</span> <span style="color: #707183;">}</span>


<span style="color: #8D8D84;">-- </span><span style="color: #8D8D84; font-style: italic;">TODO: This should probably move?</span>
<span style="color: #0000FF;">data</span> <span style="color: #6434A3;">Cluster</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Cluster</span> <span style="color: #707183;">{</span> feh <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">FeH</span>, heliumFraction <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">HeliumFraction</span>, logAge <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">LogAge</span> <span style="color: #707183;">}</span>
     <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Read</span>, <span style="color: #6434A3;">Show</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">Likelihood</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkLikelihood</span> <span style="color: #707183;">{</span> unLikelihood <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">ClosedUnitInterval</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">type</span> <span style="color: #6434A3;">EEP</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Word</span>
<span style="color: #0000FF;">type</span> <span style="color: #6434A3;">Filter</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Text</span>


<span style="color: #0000FF;">data</span> <span style="color: #6434A3;">Isochrone</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Isochrone</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">V.Vector</span> <span style="color: #6434A3;">EEP</span><span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">V.Vector</span> <span style="color: #6434A3;">Mass</span><span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">M.Map</span> <span style="color: #6434A3;">Filter</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">V.Vector</span> <span style="color: #6434A3;">AbsoluteMagnitude</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
          <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Show</span><span style="color: #707183;">)</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #8D8D84;">{-</span>
<span style="color: #8D8D84; font-style: italic;">Note [Distance Moduli]</span>
<span style="color: #8D8D84; font-style: italic;">~~~~~~~~~~~~~~~~~~~~~~</span>

<span style="color: #8D8D84; font-style: italic;">one other thing to remember is that parallax maps</span>
<span style="color: #8D8D84; font-style: italic;">to the so-called *true distance modulus*, indicated as (m-M)o, which</span>
<span style="color: #8D8D84; font-style: italic;">is not something we use in our code.  Instead BASE-9 uses the *observed</span>
<span style="color: #8D8D84; font-style: italic;">distance modulus*, indicated by (m-M)V.  The difference in the two is</span>
<span style="color: #8D8D84; font-style: italic;">due to the absorption and the transformation is</span>
<span style="color: #8D8D84; font-style: italic;">    (m-M)V = (m-M)o + Av .</span>
<span style="color: #8D8D84;">-}</span>

<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">Parallax</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkParallax</span> <span style="color: #707183;">{</span> unParallax <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">NonNegative</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">AbsoluteMagnitude</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkAbsoluteMagnitude</span> <span style="color: #707183;">{</span> unAbsoluteMagnitude <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log10</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>

<span style="color: #006699;">derivingUnbox</span> <span style="color: #008000;">"AbsoluteMagnitude"</span>
  <span style="color: #707183;">[</span>t<span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">AbsoluteMagnitude</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Log10</span> <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>
  <span style="color: #707183;">[</span><span style="color: #BA36A5;">|</span> unAbsoluteMagnitude <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>
  <span style="color: #707183;">[</span><span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">MkAbsoluteMagnitude</span> <span style="color: #BA36A5;">|</span><span style="color: #707183;">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">ApparentMagnitude</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkApparentMagniutude</span> <span style="color: #707183;">{</span> unApparentMagnitude <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log10</span> <span style="color: #707183;">}</span>
        <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>

<div id="outline-container-org6366d85" class="outline-4">
<h4 id="org6366d85"><span class="section-number-4">1.2.1.</span> Tests</h4>
<div class="outline-text-4" id="text-1-2-1">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Types.DistanceMeasuresSpec</span> <span style="color: #707183;">(</span>main, spec<span style="color: #707183;">)</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Test.Hspec</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.DistanceMeasures</span>

<span style="color: #006699;">main</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">IO</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">main</span> <span style="color: #BA36A5;">=</span> hspec spec

<span style="color: #006699;">spec</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">SpecWith</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">spec</span> <span style="color: #BA36A5;">=</span> pure <span style="color: #707183;">()</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Types.MagnitudeSpec</span> <span style="color: #707183;">(</span>main, spec<span style="color: #707183;">)</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Test.Hspec</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.Magnitude</span>

<span style="color: #006699;">main</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">IO</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">main</span> <span style="color: #BA36A5;">=</span> hspec spec

<span style="color: #006699;">spec</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">SpecWith</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">spec</span> <span style="color: #BA36A5;">=</span> pure <span style="color: #707183;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org94f3011" class="outline-4">
<h4 id="org94f3011"><span class="section-number-4">1.2.2.</span> Artifacts</h4>
<div class="outline-text-4" id="text-1-2-2">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Types.DistanceMeasures</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Parallax</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.Internal</span>

<span style="color: #BA36A5;">&lt;&lt;</span>distance measure<span style="color: #BA36A5;">&gt;&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# LANGUAGE TemplateHaskell, TypeFamilies, MultiParamTypeClasses #-}</span>
<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Types.Magnitude</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">AbsoluteMagnitude</span><span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.Internal</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Vector.Unboxed.Deriving</span>


<span style="color: #BA36A5;">&lt;&lt;</span>magnitude<span style="color: #BA36A5;">&gt;&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# LANGUAGE MultiParamTypeClasses, TypeFamilies, TemplateHaskell #-}</span>
<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Types</span> <span style="color: #707183;">(</span><span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Types.DistanceMeasures</span>
             ,<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Types.Magnitude</span>
             ,<span style="color: #6434A3;">TotalAge</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
             ,<span style="color: #6434A3;">CoolingAge</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
             ,<span style="color: #6434A3;">FeH</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
             ,<span style="color: #6434A3;">HeliumFraction</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
             ,<span style="color: #6434A3;">LogAge</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
             ,<span style="color: #6434A3;">Mass</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
             ,<span style="color: #6434A3;">Isochrone</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span>
             ,<span style="color: #6434A3;">Cluster</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.DistanceMeasures</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.Magnitude</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.Internal</span>

<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Map.Strict</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">M</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Text</span>
<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Vector.Unboxed</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">V</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Vector.Unboxed.Deriving</span>


<span style="color: #BA36A5;">&lt;&lt;</span>astro <span style="color: #0000FF;">type</span><span style="color: #BA36A5;">&gt;&gt;</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org91770f0" class="outline-3">
<h3 id="org91770f0"><span class="section-number-3">1.3.</span> Load compressed models</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Models.Input</span> <span style="color: #707183;">(</span> loadModels
                    , convertModels
                    , fetchCompactModel
                    , <span style="color: #6434A3;">Model</span>
                    , <span style="color: #6434A3;">RawModel</span>
                    , <span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Paths</span><span style="color: #707183;">)</span> <span style="color: #0000FF;">where</span>

<span style="color: #8D8D84;">-- </span><span style="color: #8D8D84; font-style: italic;">Replace this with the `compact` library?</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">GHC.Compact</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Conduit</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Conduit.Lzma</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Set</span>          <span style="color: #707183;">(</span><span style="color: #6434A3;">Set</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Text</span>         <span style="color: #707183;">(</span><span style="color: #6434A3;">Text</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Map.Strict</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">M</span>
<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Set</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">S</span> <span style="color: #707183;">(</span>toList<span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Vector.Unboxed</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">V</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">MainSequenceModel</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Paths</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.Internal</span>



<span style="color: #0000FF;">type</span> <span style="color: #6434A3;">RawModel</span> <span style="color: #BA36A5;">=</span> <span style="color: #707183;">[</span><span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #709870;">[</span><span style="color: #6434A3;">Text</span><span style="color: #709870;">]</span>, <span style="color: #6434A3;">Double</span>, <span style="color: #6434A3;">Double</span><span style="color: #909183;">)</span>, <span style="color: #6434A3;">Set</span> <span style="color: #6434A3;">Age</span><span style="color: #7388D6;">)</span><span style="color: #707183;">]</span>
<span style="color: #0000FF;">type</span> <span style="color: #6434A3;">Model</span>    <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">M.Map</span> <span style="color: #6434A3;">FeH</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">M.Map</span> <span style="color: #6434A3;">HeliumFraction</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">M.Map</span> <span style="color: #6434A3;">LogAge</span> <span style="color: #6434A3;">Isochrone</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #006699;">loadModels</span> <span style="color: #BA36A5;">::</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">MonadThrow</span> m, <span style="color: #6434A3;">HasModelPath</span> p, <span style="color: #6434A3;">MonadUnliftIO</span> m<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=&gt;</span> p <span style="color: #BA36A5;">-&gt;</span> m <span style="color: #6434A3;">RawModel</span>
<span style="color: #006699;">loadModels</span> model <span style="color: #BA36A5;">=</span> runConduitRes <span style="color: #BA36A5;">$</span> loadModel <span style="color: #BA36A5;">.|</span> sinkList
  <span style="color: #0000FF;">where</span> loadModel <span style="color: #BA36A5;">=</span> sourceFile <span style="color: #707183;">(</span>modelPath model <span style="color: #008000;">"models/"</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">.|</span> decompress <span style="color: #6434A3;">Nothing</span> <span style="color: #BA36A5;">.|</span> lexModel <span style="color: #BA36A5;">.|</span> parseModel


<span style="color: #006699;">convertModels</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">RawModel</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Model</span>
<span style="color: #006699;">convertModels</span> <span style="color: #BA36A5;">=</span> M.fromListWith <span style="color: #707183;">(</span>M.union<span style="color: #707183;">)</span> <span style="color: #BA36A5;">.</span> map go
  <span style="color: #0000FF;">where</span> go <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>filters, f, y<span style="color: #7388D6;">)</span>, isochrone<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span>
          <span style="color: #0000FF;">let</span> f'  <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkFeH</span> <span style="color: #BA36A5;">.</span> packLog <span style="color: #BA36A5;">$</span> f
              y'    <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkHeliumFraction</span> <span style="color: #BA36A5;">.</span> <span style="color: #6434A3;">MkPercentage</span> <span style="color: #BA36A5;">.</span> closedUnitInterval' <span style="color: #BA36A5;">$</span> y
              iso'  <span style="color: #BA36A5;">=</span> M.fromList <span style="color: #BA36A5;">.</span> map <span style="color: #707183;">(</span>repackAge filters<span style="color: #707183;">)</span> <span style="color: #BA36A5;">.</span> S.toList <span style="color: #BA36A5;">$</span> isochrone
          <span style="color: #0000FF;">in</span> <span style="color: #707183;">(</span>f', M.insert y' iso' mempty<span style="color: #707183;">)</span>
        repackAge filters <span style="color: #707183;">(</span><span style="color: #6434A3;">Age</span> age eeps masses magnitudes<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span>
          <span style="color: #0000FF;">let</span> age'    <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkLogAge</span> <span style="color: #BA36A5;">.</span> packLog <span style="color: #BA36A5;">$</span> age
              eeps'   <span style="color: #BA36A5;">=</span> V.map toEnum eeps
              masses' <span style="color: #BA36A5;">=</span> repackMass masses
              mags'   <span style="color: #BA36A5;">=</span> repackMags filters magnitudes
          <span style="color: #0000FF;">in</span> <span style="color: #707183;">(</span>age', <span style="color: #6434A3;">Isochrone</span> eeps' masses' mags'<span style="color: #707183;">)</span>
        repackMass v <span style="color: #BA36A5;">=</span> V.map <span style="color: #707183;">(</span><span style="color: #6434A3;">MkMass</span> <span style="color: #BA36A5;">.</span> nonNegative'<span style="color: #707183;">)</span> v
        repackMags filters v <span style="color: #BA36A5;">=</span>
          <span style="color: #0000FF;">let</span> filterSets <span style="color: #BA36A5;">=</span> map <span style="color: #707183;">(</span>V.map <span style="color: #7388D6;">(</span><span style="color: #6434A3;">MkAbsoluteMagnitude</span> <span style="color: #BA36A5;">.</span> packLog<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> v
          <span style="color: #0000FF;">in</span> M.fromList <span style="color: #BA36A5;">$</span> zip filters filterSets


<span style="color: #006699;">fetchCompactModel</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">HasModelPath</span> p <span style="color: #BA36A5;">=&gt;</span> p <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">IO</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Compact</span> <span style="color: #6434A3;">Model</span><span style="color: #707183;">)</span>
<span style="color: #006699;">fetchCompactModel</span> <span style="color: #BA36A5;">=</span> <span style="color: #707183;">(</span>compact <span style="color: #BA36A5;">=&lt;&lt;</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">.</span> fmap convertModels <span style="color: #BA36A5;">.</span> loadModels
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# LANGUAGE OverloadedLists, OverloadedStrings #-}</span>
<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Models.InputSpec</span> <span style="color: #707183;">(</span>main, spec<span style="color: #707183;">)</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Test.Hspec</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Models.Input</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Models.Sample</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Models.SampleConverted</span>

<span style="color: #006699;">main</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">IO</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">main</span> <span style="color: #BA36A5;">=</span> hspec spec

<span style="color: #006699;">spec</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">SpecWith</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">spec</span> <span style="color: #BA36A5;">=</span> describe <span style="color: #008000;">"Models.Input"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
  describe <span style="color: #008000;">"convertModels"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
    it <span style="color: #008000;">"Converts single-y RawModels in the expected manner"</span> <span style="color: #BA36A5;">$</span>
       convertModels dsed <span style="color: #BA36A5;">`shouldBe`</span> convertedDsed
    it <span style="color: #008000;">"Converts multi-y RawModels in the expected manner"</span> <span style="color: #BA36A5;">$</span>
       convertModels newDsed <span style="color: #BA36A5;">`shouldBe`</span> convertedNewDsed
</pre>
</div>
</div>
</div>

<div id="outline-container-org83455f5" class="outline-3">
<h3 id="org83455f5"><span class="section-number-3">1.4.</span> Model interpolation</h3>
<div class="outline-text-3" id="text-1-4">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# LANGUAGE FlexibleContexts, StandaloneDeriving, GeneralizedNewtypeDeriving, NoMonomorphismRestriction #-}</span>
<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Control.Exception</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Exception</span>, throw<span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Map.Strict</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">M</span>
<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Vector.Unboxed</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">V</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Models.Input</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Model</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.Internal</span>


<span style="color: #0000FF;">data</span> <span style="color: #6434A3;">InterpolationException</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">EmptyModelException</span>
                            <span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">UnmatchedEEPException</span>
     <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Exception</span> <span style="color: #6434A3;">InterpolationException</span>


<span style="color: #0000FF;">type</span> <span style="color: #6434A3;">HeliumFractionMap</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">M.Map</span> <span style="color: #6434A3;">HeliumFraction</span> <span style="color: #6434A3;">LogAgeMap</span>
<span style="color: #0000FF;">type</span> <span style="color: #6434A3;">LogAgeMap</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">M.Map</span> <span style="color: #6434A3;">LogAge</span> <span style="color: #6434A3;">Isochrone</span>


<span style="color: #006699;">interpolateIsochrone</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Cluster</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Model</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Isochrone</span>
<span style="color: #006699;">interpolateIsochrone</span> <span style="color: #BA36A5;">=</span> <span style="color: #707183;">(</span>interpolateGeneric feh<span style="color: #707183;">)</span> <span style="color: #BA36A5;">`next`</span> <span style="color: #707183;">(</span>interpolateGeneric heliumFraction<span style="color: #707183;">)</span> <span style="color: #BA36A5;">`next`</span> interpolateLogAge


<span style="color: #006699;">next</span> <span style="color: #BA36A5;">::</span> a <span style="color: #BA36A5;">-&gt;</span> a
<span style="color: #006699;">next</span> <span style="color: #BA36A5;">=</span> id

<span style="color: #0000FF;">infixr</span> 1 <span style="color: #BA36A5;">`next`</span>


<span style="color: #006699;">interpolateGeneric</span> <span style="color: #BA36A5;">::</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Ord</span> a, <span style="color: #6434A3;">Interpolate</span> a<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=&gt;</span> <span style="color: #707183;">(</span>t1 <span style="color: #BA36A5;">-&gt;</span> a<span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #707183;">(</span>t1 <span style="color: #BA36A5;">-&gt;</span> t2 <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Isochrone</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> t1 <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">M.Map</span> a t2 <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Isochrone</span>
<span style="color: #006699;">interpolateGeneric</span> unpack nextLayer c m <span style="color: #BA36A5;">=</span> go <span style="color: #BA36A5;">$</span> M.splitLookup <span style="color: #707183;">(</span>unpack c<span style="color: #707183;">)</span> m
  <span style="color: #0000FF;">where</span> go <span style="color: #707183;">(</span><span style="color: #0000FF;">_</span>, <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Just</span> v<span style="color: #7388D6;">)</span>, <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> nextLayer c v
        go <span style="color: #707183;">(</span>l,        <span style="color: #0000FF;">_</span>, r<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">case</span> <span style="color: #707183;">(</span>null l, null r<span style="color: #707183;">)</span> <span style="color: #0000FF;">of</span>
                                <span style="color: #707183;">(</span> <span style="color: #6434A3;">True</span>,  <span style="color: #6434A3;">True</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> throw <span style="color: #6434A3;">EmptyModelException</span>
                                <span style="color: #707183;">(</span> <span style="color: #6434A3;">True</span>, <span style="color: #6434A3;">False</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> interp <span style="color: #BA36A5;">.</span> M.findMin <span style="color: #BA36A5;">$</span> r   <span style="color: #8D8D84;">-- </span><span style="color: #8D8D84; font-style: italic;">Note [Extrapolation]</span>
                                <span style="color: #707183;">(</span><span style="color: #6434A3;">False</span>,  <span style="color: #6434A3;">True</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> interp <span style="color: #BA36A5;">.</span> M.findMax <span style="color: #BA36A5;">$</span> l
                                <span style="color: #707183;">(</span><span style="color: #6434A3;">False</span>, <span style="color: #6434A3;">False</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #0000FF;">let</span> l' <span style="color: #BA36A5;">=</span> M.findMax l
                                                      r' <span style="color: #BA36A5;">=</span> M.findMin r
                                                      li <span style="color: #BA36A5;">=</span> interp l'
                                                      ri <span style="color: #BA36A5;">=</span> interp r'
                                                      f  <span style="color: #BA36A5;">=</span> interpolationFraction <span style="color: #707183;">(</span>fst l'<span style="color: #707183;">)</span> <span style="color: #707183;">(</span>fst r'<span style="color: #707183;">)</span> <span style="color: #707183;">(</span>unpack c<span style="color: #707183;">)</span>
                                                  <span style="color: #0000FF;">in</span> interpolateIsochrones f li ri
        interp <span style="color: #BA36A5;">=</span> nextLayer c <span style="color: #BA36A5;">.</span> snd

<span style="color: #8D8D84;">{-</span>
<span style="color: #8D8D84; font-style: italic;">Note [Extrapolation]</span>
<span style="color: #8D8D84; font-style: italic;">~~~~~~~~~~~~~~~~~~~~</span>

<span style="color: #8D8D84; font-style: italic;">Extrapolation is not allowed by this code, in that, if an interpolation target falls between the left or right boundary (null == True conditions for the either list) and a non-null list,</span>
<span style="color: #8D8D84;">-}</span>


<span style="color: #006699;">interpolateLogAge</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Cluster</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">LogAgeMap</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Isochrone</span>
<span style="color: #006699;">interpolateLogAge</span> c m <span style="color: #BA36A5;">=</span> go <span style="color: #BA36A5;">$</span> M.splitLookup <span style="color: #707183;">(</span>logAge c<span style="color: #707183;">)</span> m
  <span style="color: #0000FF;">where</span> go <span style="color: #BA36A5;">::</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">LogAgeMap</span>, <span style="color: #6434A3;">Maybe</span> <span style="color: #6434A3;">Isochrone</span>, <span style="color: #6434A3;">LogAgeMap</span><span style="color: #707183;">)</span>
           <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Isochrone</span>
        go <span style="color: #707183;">(</span><span style="color: #0000FF;">_</span>, <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Just</span> v<span style="color: #7388D6;">)</span>, <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> v
        go <span style="color: #707183;">(</span>l,        <span style="color: #0000FF;">_</span>, r<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">case</span> <span style="color: #707183;">(</span>null l, null r<span style="color: #707183;">)</span> <span style="color: #0000FF;">of</span>
                                <span style="color: #707183;">(</span> <span style="color: #6434A3;">True</span>,  <span style="color: #6434A3;">True</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> throw <span style="color: #6434A3;">EmptyModelException</span>
                                <span style="color: #707183;">(</span> <span style="color: #6434A3;">True</span>, <span style="color: #6434A3;">False</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> snd <span style="color: #BA36A5;">.</span> M.findMin <span style="color: #BA36A5;">$</span> r
                                <span style="color: #707183;">(</span><span style="color: #6434A3;">False</span>,  <span style="color: #6434A3;">True</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> snd <span style="color: #BA36A5;">.</span> M.findMax <span style="color: #BA36A5;">$</span> l
                                <span style="color: #707183;">(</span><span style="color: #6434A3;">False</span>, <span style="color: #6434A3;">False</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #0000FF;">let</span> l' <span style="color: #BA36A5;">=</span> M.findMax l
                                                      r' <span style="color: #BA36A5;">=</span> M.findMin r
                                                      f  <span style="color: #BA36A5;">=</span> interpolationFraction <span style="color: #707183;">(</span>fst l'<span style="color: #707183;">)</span> <span style="color: #707183;">(</span>fst r'<span style="color: #707183;">)</span> <span style="color: #707183;">(</span>logAge c<span style="color: #707183;">)</span>
                                                  <span style="color: #0000FF;">in</span> interpolateIsochrones f <span style="color: #707183;">(</span>snd l'<span style="color: #707183;">)</span> <span style="color: #707183;">(</span>snd r'<span style="color: #707183;">)</span>


<span style="color: #006699;">interpolateIsochrones</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">ClosedUnitInterval</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Isochrone</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Isochrone</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Isochrone</span>
<span style="color: #006699;">interpolateIsochrones</span> f <span style="color: #707183;">(</span><span style="color: #6434A3;">Isochrone</span> eeps1 masses1 mags1<span style="color: #707183;">)</span>
                        <span style="color: #707183;">(</span><span style="color: #6434A3;">Isochrone</span> eeps2 masses2 mags2<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span>
  <span style="color: #0000FF;">let</span> minEep <span style="color: #BA36A5;">=</span> max <span style="color: #707183;">(</span>V.minimum eeps1<span style="color: #707183;">)</span> <span style="color: #707183;">(</span>V.minimum eeps2<span style="color: #707183;">)</span>
      toDrop <span style="color: #BA36A5;">=</span> V.length <span style="color: #BA36A5;">.</span> V.takeWhile <span style="color: #707183;">(</span><span style="color: #BA36A5;">&lt;</span> minEep<span style="color: #707183;">)</span> <span style="color: #8D8D84;">-- </span><span style="color: #8D8D84; font-style: italic;">number of records to drop to match EEPs</span>
      drop1  <span style="color: #BA36A5;">=</span> toDrop eeps1
      drop2  <span style="color: #BA36A5;">=</span> toDrop eeps2
      dropThenZipWith func v1 v2 <span style="color: #BA36A5;">=</span>
        <span style="color: #0000FF;">let</span> v1' <span style="color: #BA36A5;">=</span> V.drop drop1 v1
            v2' <span style="color: #BA36A5;">=</span> V.drop drop2 v2
        <span style="color: #0000FF;">in</span> V.zipWith func v1' v2'
      ensureEeps <span style="color: #BA36A5;">=</span> V.and <span style="color: #BA36A5;">$</span> dropThenZipWith <span style="color: #707183;">(</span><span style="color: #BA36A5;">==</span><span style="color: #707183;">)</span> eeps1 eeps2
      interp <span style="color: #BA36A5;">=</span> interpolate f
  <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">if</span> not ensureEeps
        <span style="color: #0000FF;">then</span> throw <span style="color: #6434A3;">UnmatchedEEPException</span>
        <span style="color: #0000FF;">else</span> <span style="color: #6434A3;">Isochrone</span> <span style="color: #707183;">(</span>V.drop drop1 eeps1<span style="color: #707183;">)</span>
                       <span style="color: #707183;">(</span>dropThenZipWith interp masses1 masses2<span style="color: #707183;">)</span>
                       <span style="color: #707183;">(</span>M.unionWith <span style="color: #7388D6;">(</span>dropThenZipWith interp<span style="color: #7388D6;">)</span> mags1 mags2<span style="color: #707183;">)</span>


<span style="color: #8D8D84;">--</span><span style="color: #8D8D84; font-style: italic;">{-@ assume linearInterpolate :: (Fractional a) =&gt; ClosedUnitInterval -&gt; l:a -&gt; {h:a | l &lt;= h} -&gt; {v:a | l &lt;= v &amp;&amp; v &lt;= h} @-}</span>
<span style="color: #006699;">linearInterpolate</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Fractional</span> a <span style="color: #BA36A5;">=&gt;</span> <span style="color: #6434A3;">ClosedUnitInterval</span> <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a
<span style="color: #006699;">linearInterpolate</span> f' x1 x2 <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">let</span> f <span style="color: #BA36A5;">=</span> realToFrac <span style="color: #BA36A5;">.</span> unClosedUnitInterval <span style="color: #BA36A5;">$</span> f' <span style="color: #0000FF;">in</span> f <span style="color: #BA36A5;">*</span> x2 <span style="color: #BA36A5;">+</span> <span style="color: #707183;">(</span>1 <span style="color: #BA36A5;">-</span> f<span style="color: #707183;">)</span> <span style="color: #BA36A5;">*</span> x1

<span style="color: #8D8D84;">{-</span>
<span style="color: #8D8D84; font-style: italic;">Note [References]</span>
<span style="color: #8D8D84; font-style: italic;">~~~~~~~~~~~~~~~~~</span>
<span style="color: #8D8D84; font-style: italic;">  eq. 3, published_other/interpolation/log_interpol.pdf</span>
<span style="color: #8D8D84; font-style: italic;">  unpublished/robinson/interpolation/linear_proof.txt</span>
<span style="color: #8D8D84;">-}</span>


<span style="color: #8D8D84;">--</span><span style="color: #8D8D84; font-style: italic;">{-@ linearInterpolationFraction :: l:Double -&gt; h:(GTE l) -&gt; Btwn l h -&gt; ClosedUnitInterval @-}</span>
<span style="color: #006699;">linearInterpolationFraction</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">ClosedUnitInterval</span>
<span style="color: #006699;">linearInterpolationFraction</span> l h m <span style="color: #BA36A5;">=</span>
  <span style="color: #0000FF;">let</span> a <span style="color: #BA36A5;">=</span> m <span style="color: #BA36A5;">-</span> l
      range <span style="color: #BA36A5;">=</span> h <span style="color: #BA36A5;">-</span> l
  <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">if</span> l <span style="color: #BA36A5;">==</span> h
        <span style="color: #0000FF;">then</span> closedUnitInterval_unsafe 0
        <span style="color: #0000FF;">else</span> closedUnitInterval' <span style="color: #BA36A5;">$</span> a <span style="color: #BA36A5;">/</span> range

<span style="color: #8D8D84;">{-</span>
<span style="color: #8D8D84; font-style: italic;">Note [References]</span>
<span style="color: #8D8D84; font-style: italic;">~~~~~~~~~~~~~~~~~</span>
<span style="color: #8D8D84; font-style: italic;">  eq. 2, published_other/interpolation/log_interpol.pdf</span>
<span style="color: #8D8D84;">-}</span>


<span style="color: #8D8D84;">--</span><span style="color: #8D8D84; font-style: italic;">{-@ logInterpolate :: LogSpace a =&gt; ClosedUnitInterval -&gt; l:a -&gt; {h:a | l &lt;= h} -&gt; {v:a | l &lt;= v &amp;&amp; v &lt;= h} @-}</span>
<span style="color: #006699;">logInterpolate</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">LogSpace</span> a <span style="color: #BA36A5;">=&gt;</span> <span style="color: #6434A3;">ClosedUnitInterval</span> <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a
<span style="color: #006699;">logInterpolate</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">MkClosedUnitInterval</span> 0.0<span style="color: #707183;">)</span> x1  <span style="color: #0000FF;">_</span> <span style="color: #BA36A5;">=</span> x1
<span style="color: #006699;">logInterpolate</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">MkClosedUnitInterval</span> 1.0<span style="color: #707183;">)</span>  <span style="color: #0000FF;">_</span> x2 <span style="color: #BA36A5;">=</span> x2
<span style="color: #006699;">logInterpolate</span> f x1 x2 <span style="color: #BA36A5;">=</span> toLogSpace <span style="color: #BA36A5;">$</span> nonNegative' <span style="color: #BA36A5;">$</span> linearInterpolate f <span style="color: #707183;">(</span>unpack x1<span style="color: #707183;">)</span> <span style="color: #707183;">(</span>unpack x2<span style="color: #707183;">)</span> <span style="color: #8D8D84;">-- </span><span style="color: #8D8D84; font-style: italic;">Note [Log Interpolation]</span>
  <span style="color: #0000FF;">where</span> unpack <span style="color: #BA36A5;">=</span> unNonNegative <span style="color: #BA36A5;">.</span> fromLogSpace

<span style="color: #8D8D84;">{-</span>
<span style="color: #8D8D84; font-style: italic;">Note [Log interpolation]</span>
<span style="color: #8D8D84; font-style: italic;">~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span style="color: #8D8D84; font-style: italic;">Log interpolation using the ((x2 ** f) * (x1 ** (1 - f))) equation, despite the</span>
<span style="color: #8D8D84; font-style: italic;">proof (Note [References]), is broken. The result of raising a negative</span>
<span style="color: #8D8D84; font-style: italic;">Fractional (e.g., a non-log value greater than 0 but less than 1) to a</span>
<span style="color: #8D8D84; font-style: italic;">non-integer power is Complex, which results in NaN in many cases.</span>

<span style="color: #8D8D84; font-style: italic;">We may want to look back at this eventually for performance purposes, but it's</span>
<span style="color: #8D8D84; font-style: italic;">possible that the (**) is going through exp/log anyway (i.e., no benefit). One potential fix would be to double memory residency by carrying both log- and non-log-space values.</span>

<span style="color: #8D8D84; font-style: italic;">Note [References]</span>
<span style="color: #8D8D84; font-style: italic;">~~~~~~~~~~~~~~~~~</span>
<span style="color: #8D8D84; font-style: italic;">  eq. 5, published_other/interpolation/log_interpol.pdf</span>
<span style="color: #8D8D84; font-style: italic;">  unpublished/robinson/interpolation/log_proof.txt</span>
<span style="color: #8D8D84;">-}</span>


<span style="color: #006699;">logInterpolationFraction</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">LogSpace</span> a <span style="color: #BA36A5;">=&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">ClosedUnitInterval</span>
<span style="color: #006699;">logInterpolationFraction</span> l' h' m' <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">let</span> l <span style="color: #BA36A5;">=</span> unpack l'
                                        h <span style="color: #BA36A5;">=</span> unpack h'
                                        m <span style="color: #BA36A5;">=</span> unpack m'
                                    <span style="color: #0000FF;">in</span> linearInterpolationFraction l h m
  <span style="color: #0000FF;">where</span> unpack <span style="color: #BA36A5;">=</span> unNonNegative <span style="color: #BA36A5;">.</span> fromLogSpace


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">Interpolate</span> a <span style="color: #0000FF;">where</span>
  interpolate <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">ClosedUnitInterval</span> <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a
  interpolationFraction <span style="color: #BA36A5;">::</span> a <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">ClosedUnitInterval</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">Double</span> <span style="color: #0000FF;">where</span>
  interpolate <span style="color: #BA36A5;">=</span> linearInterpolate
  interpolationFraction <span style="color: #BA36A5;">=</span> linearInterpolationFraction

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">NaturalLog</span> <span style="color: #0000FF;">where</span>
  interpolate <span style="color: #BA36A5;">=</span> logInterpolate
  interpolationFraction <span style="color: #BA36A5;">=</span> logInterpolationFraction

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">Log10</span> <span style="color: #0000FF;">where</span>
  interpolate <span style="color: #BA36A5;">=</span> logInterpolate
  interpolationFraction <span style="color: #BA36A5;">=</span> logInterpolationFraction

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">Log2</span> <span style="color: #0000FF;">where</span>
  interpolate <span style="color: #BA36A5;">=</span> logInterpolate
  interpolationFraction <span style="color: #BA36A5;">=</span> logInterpolationFraction

<span style="color: #0000FF;">deriving</span> <span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">FeH</span>
<span style="color: #0000FF;">deriving</span> <span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">LogAge</span>
<span style="color: #0000FF;">deriving</span> <span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">AbsoluteMagnitude</span>

<span style="color: #0000FF;">deriving</span> <span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">NonNegative</span>
<span style="color: #0000FF;">deriving</span> <span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">Mass</span>

<span style="color: #0000FF;">deriving</span> <span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">ClosedUnitInterval</span>
<span style="color: #0000FF;">deriving</span> <span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">Percentage</span>
<span style="color: #0000FF;">deriving</span> <span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Interpolate</span> <span style="color: #6434A3;">HeliumFraction</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# LANGUAGE NoMonomorphismRestriction, TypeApplications #-}</span>
<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">InterpolateSpec</span> <span style="color: #707183;">(</span>main, spec<span style="color: #707183;">)</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.List</span> <span style="color: #707183;">(</span>sort<span style="color: #707183;">)</span>

<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Map.Strict</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">M</span>
<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Vector.Unboxed</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">V</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Test.Hspec</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Test.QuickCheck</span> <span style="color: #0000FF;">hiding</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Positive</span><span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Models.Input</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Models.Sample</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Interpolate</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.Internal</span>


<span style="color: #006699;">main</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">IO</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">main</span> <span style="color: #BA36A5;">=</span> hspec spec


<span style="color: #006699;">spec</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">SpecWith</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">spec</span> <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span>
  logInterpolateSpec
  linearInterpolateSpec

  isochroneSpec
  interpolationFractionSpec


<span style="color: #006699;">shouldBeCloseToD</span> <span style="color: #BA36A5;">::</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Num</span> a, <span style="color: #6434A3;">Ord</span> a, <span style="color: #6434A3;">Show</span> a<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Expectation</span>
<span style="color: #006699;">shouldBeCloseToD</span> delta x1 x2 <span style="color: #BA36A5;">=</span> abs <span style="color: #707183;">(</span>x2 <span style="color: #BA36A5;">-</span> x1<span style="color: #707183;">)</span> <span style="color: #BA36A5;">`shouldSatisfy`</span> <span style="color: #707183;">(</span><span style="color: #BA36A5;">&lt;</span> delta<span style="color: #707183;">)</span>


<span style="color: #006699;">shouldBeCloseTo</span> <span style="color: #BA36A5;">::</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Num</span> a, <span style="color: #6434A3;">Ord</span> a, <span style="color: #6434A3;">Fractional</span> a, <span style="color: #6434A3;">Show</span> a<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> a <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Expectation</span>
<span style="color: #006699;">shouldBeCloseTo</span> <span style="color: #BA36A5;">=</span> shouldBeCloseToD <span style="color: #707183;">(</span>realToFrac <span style="color: #BA36A5;">@</span><span style="color: #6434A3;">Double</span> 0.000001<span style="color: #707183;">)</span>


<span style="color: #006699;">logInterpolateSpec</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">SpecWith</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">logInterpolateSpec</span> <span style="color: #BA36A5;">=</span> parallel <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
  describe <span style="color: #008000;">"log interpolation (per paper)"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
    describe <span style="color: #008000;">"hard-coded"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      it <span style="color: #008000;">"two average stellar ages"</span> <span style="color: #BA36A5;">$</span>
         unpack <span style="color: #707183;">(</span>logInterpolate <span style="color: #7388D6;">(</span>closedUnitInterval' 0.5<span style="color: #7388D6;">)</span>
                                <span style="color: #7388D6;">(</span>toLogSpace <span style="color: #BA36A5;">$</span> nonNegative_unsafe 0.0<span style="color: #7388D6;">)</span>
                                <span style="color: #7388D6;">(</span>toLogSpace <span style="color: #BA36A5;">$</span> nonNegative_unsafe 5.0<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
           <span style="color: #BA36A5;">`shouldBeCloseTo`</span> 2.5

    it <span style="color: #008000;">"is a linear interpolation in log space"</span> <span style="color: #BA36A5;">$</span> property <span style="color: #BA36A5;">$</span>
       <span style="color: #BA36A5;">\</span>f x y <span style="color: #BA36A5;">-&gt;</span>
         <span style="color: #0000FF;">let</span> x_unpacked <span style="color: #BA36A5;">=</span> unpack x
             y_unpacked <span style="color: #BA36A5;">=</span> unpack y
         <span style="color: #0000FF;">in</span> unpack <span style="color: #707183;">(</span>logInterpolate f x y<span style="color: #707183;">)</span>
              <span style="color: #BA36A5;">`shouldBeCloseTo`</span>
              linearInterpolate f x_unpacked y_unpacked

    it <span style="color: #008000;">"returns x1 when f = 0.0"</span> <span style="color: #BA36A5;">$</span> property <span style="color: #BA36A5;">$</span>
       <span style="color: #BA36A5;">\</span>x y <span style="color: #BA36A5;">-&gt;</span> logInterpolate <span style="color: #707183;">(</span>closedUnitInterval' 0.0<span style="color: #707183;">)</span> x y <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #707183;">(</span>x <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log10</span><span style="color: #707183;">)</span>

    it <span style="color: #008000;">"returns x2 when f = 1.0"</span> <span style="color: #BA36A5;">$</span> property <span style="color: #BA36A5;">$</span>
       <span style="color: #BA36A5;">\</span>x y <span style="color: #BA36A5;">-&gt;</span> logInterpolate <span style="color: #707183;">(</span>closedUnitInterval' 1.0<span style="color: #707183;">)</span> x y <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #707183;">(</span>y <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log10</span><span style="color: #707183;">)</span>
  <span style="color: #0000FF;">where</span> unpack <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log10</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Double</span>
        unpack <span style="color: #BA36A5;">=</span> unNonNegative <span style="color: #BA36A5;">.</span> fromLogSpace


<span style="color: #006699;">linearInterpolateSpec</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">SpecWith</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">linearInterpolateSpec</span> <span style="color: #BA36A5;">=</span> describe <span style="color: #008000;">"linear interpolation"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
    it <span style="color: #008000;">"returns x1 when f = 0.0"</span> <span style="color: #BA36A5;">$</span> property <span style="color: #BA36A5;">$</span>
       <span style="color: #BA36A5;">\</span>x y <span style="color: #BA36A5;">-&gt;</span> <span style="color: #707183;">(</span>linearInterpolate <span style="color: #7388D6;">(</span>closedUnitInterval' 0.0<span style="color: #7388D6;">)</span> x y <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #7388D6;">(</span>x <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
    it <span style="color: #008000;">"returns x2 when f = 1.0"</span> <span style="color: #BA36A5;">$</span> property <span style="color: #BA36A5;">$</span>
       <span style="color: #BA36A5;">\</span>x y <span style="color: #BA36A5;">-&gt;</span> <span style="color: #707183;">(</span>linearInterpolate <span style="color: #7388D6;">(</span>closedUnitInterval' 1.0<span style="color: #7388D6;">)</span> x y <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #7388D6;">(</span>y <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
    it <span style="color: #008000;">"returns halfway between x1 and x2 when f = 0.5"</span> <span style="color: #BA36A5;">$</span> property <span style="color: #BA36A5;">$</span>
       <span style="color: #BA36A5;">\</span>x y <span style="color: #BA36A5;">-&gt;</span> <span style="color: #707183;">(</span>linearInterpolate <span style="color: #7388D6;">(</span>closedUnitInterval' 0.5<span style="color: #7388D6;">)</span> x y <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #7388D6;">(</span>0.5 <span style="color: #BA36A5;">*</span> x <span style="color: #BA36A5;">+</span> 0.5 <span style="color: #BA36A5;">*</span> <span style="color: #909183;">(</span>y <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #808080;">{-@ assume sort :: Ord a =&gt; o:[a] -&gt; {v:[a] | len v == len o} @-}</span>

<span style="color: #006699;">interpolationFractionSpec</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">SpecWith</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">interpolationFractionSpec</span> <span style="color: #BA36A5;">=</span> describe <span style="color: #008000;">"interpolation fractions"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
  describe <span style="color: #008000;">"linear"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
    it <span style="color: #008000;">"is in closed unit interval"</span> <span style="color: #BA36A5;">$</span> property <span style="color: #BA36A5;">$</span>
       <span style="color: #BA36A5;">\</span>x y z <span style="color: #BA36A5;">-&gt;</span>
         <span style="color: #0000FF;">let</span> sorted <span style="color: #BA36A5;">=</span> sort <span style="color: #707183;">[</span>x, y, z<span style="color: #707183;">]</span>
         <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">let</span> l <span style="color: #BA36A5;">=</span> sorted <span style="color: #BA36A5;">!!</span> 0
                m <span style="color: #BA36A5;">=</span> sorted <span style="color: #BA36A5;">!!</span> 1
                h <span style="color: #BA36A5;">=</span> sorted <span style="color: #BA36A5;">!!</span> 2
                result <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">if</span> l <span style="color: #BA36A5;">==</span> h
                            <span style="color: #0000FF;">then</span> closedUnitInterval_unsafe 0
                            <span style="color: #0000FF;">else</span> closedUnitInterval' <span style="color: #BA36A5;">$</span> <span style="color: #707183;">(</span>m <span style="color: #BA36A5;">-</span> l<span style="color: #707183;">)</span> <span style="color: #BA36A5;">/</span> <span style="color: #707183;">(</span>h <span style="color: #BA36A5;">-</span> l<span style="color: #707183;">)</span>
            <span style="color: #0000FF;">in</span> <span style="color: #707183;">(</span>linearInterpolationFraction l h m<span style="color: #707183;">)</span> <span style="color: #BA36A5;">`shouldBe`</span> result

  describe <span style="color: #008000;">"log"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
    it <span style="color: #008000;">"is linear interpolation fraction in log space"</span> <span style="color: #BA36A5;">$</span> property <span style="color: #BA36A5;">$</span>
       <span style="color: #BA36A5;">\</span>x y z <span style="color: #BA36A5;">-&gt;</span>
         <span style="color: #0000FF;">let</span> sorted <span style="color: #BA36A5;">=</span> sort <span style="color: #707183;">[</span>x, y, z<span style="color: #707183;">]</span>
             l <span style="color: #BA36A5;">=</span> sorted <span style="color: #BA36A5;">!!</span> 0
             m <span style="color: #BA36A5;">=</span> sorted <span style="color: #BA36A5;">!!</span> 1
             h <span style="color: #BA36A5;">=</span> sorted <span style="color: #BA36A5;">!!</span> 2
             lu <span style="color: #BA36A5;">=</span> unpack l
             mu <span style="color: #BA36A5;">=</span> unpack m
             hu <span style="color: #BA36A5;">=</span> unpack h
         <span style="color: #0000FF;">in</span> logInterpolationFraction l h m <span style="color: #BA36A5;">`shouldBe`</span> linearInterpolationFraction lu hu mu
  <span style="color: #0000FF;">where</span> unpack <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Log10</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Double</span>
        unpack <span style="color: #BA36A5;">=</span> unNonNegative <span style="color: #BA36A5;">.</span> fromLogSpace


<span style="color: #006699;">isochroneSpec</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">SpecWith</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">isochroneSpec</span> <span style="color: #BA36A5;">=</span> describe <span style="color: #008000;">"isochrone interpolation"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
    it <span style="color: #008000;">"returns the first when the scaling parameter is 0.0"</span> <span style="color: #BA36A5;">$</span>
       <span style="color: #707183;">(</span>interpolateIsochrones <span style="color: #7388D6;">(</span><span style="color: #6434A3;">MkClosedUnitInterval</span> 0.0<span style="color: #7388D6;">)</span> i1 i2<span style="color: #707183;">)</span>
         <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #707183;">(</span><span style="color: #0000FF;">let</span> trunc <span style="color: #BA36A5;">=</span> V.singleton <span style="color: #BA36A5;">.</span> V.last
                     <span style="color: #0000FF;">in</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Isochrone</span> <span style="color: #909183;">(</span>trunc <span style="color: #BA36A5;">$</span> eeps i1<span style="color: #909183;">)</span>
                                   <span style="color: #909183;">(</span>trunc <span style="color: #BA36A5;">$</span> mass i1<span style="color: #909183;">)</span>
                                   <span style="color: #909183;">(</span>M.map trunc <span style="color: #BA36A5;">$</span> mags i1<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
    it <span style="color: #008000;">"returns the second when the scaling parameter is 1.0"</span> <span style="color: #BA36A5;">$</span>
       <span style="color: #707183;">(</span>interpolateIsochrones <span style="color: #7388D6;">(</span>closedUnitInterval' 1.0<span style="color: #7388D6;">)</span> i1 i2<span style="color: #707183;">)</span>
         <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #707183;">(</span><span style="color: #0000FF;">let</span> trunc <span style="color: #BA36A5;">=</span> V.take 1
                     <span style="color: #0000FF;">in</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Isochrone</span> <span style="color: #909183;">(</span>trunc <span style="color: #BA36A5;">$</span> eeps i2<span style="color: #909183;">)</span>
                                   <span style="color: #909183;">(</span>trunc <span style="color: #BA36A5;">$</span> mass i2<span style="color: #909183;">)</span>
                                   <span style="color: #909183;">(</span>M.map trunc <span style="color: #BA36A5;">$</span> mags i2<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
  <span style="color: #0000FF;">where</span> i1 <span style="color: #BA36A5;">=</span> snd <span style="color: #BA36A5;">.</span> M.findMin <span style="color: #BA36A5;">.</span> snd <span style="color: #BA36A5;">.</span> M.findMin <span style="color: #BA36A5;">.</span> snd <span style="color: #BA36A5;">.</span> M.findMin <span style="color: #BA36A5;">$</span> convertModels newDsed
        i2 <span style="color: #BA36A5;">=</span> snd <span style="color: #BA36A5;">.</span> M.findMax <span style="color: #BA36A5;">.</span> snd <span style="color: #BA36A5;">.</span> M.findMax <span style="color: #BA36A5;">.</span> snd <span style="color: #BA36A5;">.</span> M.findMin <span style="color: #BA36A5;">$</span> convertModels newDsed
        eeps <span style="color: #707183;">(</span><span style="color: #6434A3;">Isochrone</span> v <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> v
        mass <span style="color: #707183;">(</span><span style="color: #6434A3;">Isochrone</span> <span style="color: #0000FF;">_</span> v <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> v
        mags <span style="color: #707183;">(</span><span style="color: #6434A3;">Isochrone</span> <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span> v<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> v
</pre>
</div>
</div>
</div>

<div id="outline-container-orga2d676a" class="outline-3">
<h3 id="orga2d676a"><span class="section-number-3">1.5.</span> Example model input and expected internal representations</h3>
<div class="outline-text-3" id="text-1-5">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# LANGUAGE OverloadedLists, OverloadedStrings #-}</span>
<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Models.Sample</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">MainSequenceModel</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Age</span><span style="color: #7388D6;">(</span><span style="color: #BA36A5;">..</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Models.Input</span>


<span style="color: #006699;">dsed</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">RawModel</span>
<span style="color: #006699;">dsed</span> <span style="color: #BA36A5;">=</span> <span style="color: #707183;">[</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #709870;">[</span><span style="color: #008000;">"U"</span>, <span style="color: #008000;">"B"</span>, <span style="color: #008000;">"V"</span><span style="color: #709870;">]</span>, <span style="color: #BA36A5;">-</span>2.5, 0.2451<span style="color: #909183;">)</span>
         , <span style="color: #909183;">[</span> <span style="color: #6434A3;">Age</span> 8.39794
                 <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                 <span style="color: #709870;">[</span>0.278163, 0.318852, 0.335466, 0.351598<span style="color: #709870;">]</span>
                 <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>11.7478, 11.3514, 11.2028, 11.0572<span style="color: #907373;">]</span>
                 , <span style="color: #907373;">[</span>11.0484, 10.7092, 10.5813, 10.4578<span style="color: #907373;">]</span>
                 , <span style="color: #907373;">[</span>9.8499,  9.5412,  9.4241,  9.3119<span style="color: #907373;">]</span><span style="color: #709870;">]</span>
           , <span style="color: #6434A3;">Age</span> 8.477121
                 <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                 <span style="color: #709870;">[</span>0.212681, 0.290489, 0.320389, 0.335518<span style="color: #709870;">]</span>
                 <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>12.5728, 11.6188, 11.3348, 11.2034<span style="color: #907373;">]</span>
                 , <span style="color: #907373;">[</span>11.7446, 10.9382, 10.6947, 10.5822<span style="color: #907373;">]</span>
                 , <span style="color: #907373;">[</span>10.4768, 9.7498,  9.5277,  9.4251<span style="color: #907373;">]</span><span style="color: #709870;">]</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>
       , <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #709870;">[</span><span style="color: #008000;">"U"</span>, <span style="color: #008000;">"B"</span>, <span style="color: #008000;">"V"</span><span style="color: #709870;">]</span>, <span style="color: #BA36A5;">-</span>2.0, 0.2453<span style="color: #909183;">)</span>
         , <span style="color: #909183;">[</span> <span style="color: #6434A3;">Age</span> 8.397940
                 <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                 <span style="color: #709870;">[</span>0.297801, 0.335484, 0.338823, 0.355097<span style="color: #709870;">]</span>
                 <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>12.1589, 11.8031, 11.7674, 11.5974<span style="color: #907373;">]</span>
                 , <span style="color: #907373;">[</span>11.2562, 10.9432, 10.9126, 10.7646<span style="color: #907373;">]</span>
                 , <span style="color: #907373;">[</span>9.9655,  9.6821,  9.6546,  9.5203<span style="color: #907373;">]</span><span style="color: #709870;">]</span>
           , <span style="color: #6434A3;">Age</span> 8.477121
                 <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                 <span style="color: #709870;">[</span>0.251276, 0.317207, 0.335075, 0.337718<span style="color: #709870;">]</span>
                 <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>12.6621, 11.9778, 11.8076, 11.7862<span style="color: #907373;">]</span>
                 , <span style="color: #907373;">[</span>11.6918, 11.0959, 10.9477, 10.9296<span style="color: #907373;">]</span>
                 , <span style="color: #907373;">[</span>10.3548, 9.8205,  9.6866,  9.6705<span style="color: #907373;">]</span><span style="color: #709870;">]</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">]</span>


<span style="color: #006699;">newDsed</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">RawModel</span>
<span style="color: #006699;">newDsed</span> <span style="color: #BA36A5;">=</span> <span style="color: #707183;">[</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #709870;">[</span><span style="color: #008000;">"U"</span>, <span style="color: #008000;">"B"</span>, <span style="color: #008000;">"V"</span><span style="color: #709870;">]</span>, <span style="color: #BA36A5;">-</span>1.0, 0.247800<span style="color: #909183;">)</span>
            , <span style="color: #909183;">[</span> <span style="color: #6434A3;">Age</span> 9.0
                    <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                    <span style="color: #709870;">[</span>0.113315, 0.124680, 0.140813, 0.173692<span style="color: #709870;">]</span>
                    <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>17.03370, 16.62740, 16.12280, 15.25250<span style="color: #907373;">]</span>
                    , <span style="color: #907373;">[</span>15.03530, 14.70540, 14.29240, 13.58510<span style="color: #907373;">]</span>
                    , <span style="color: #907373;">[</span>13.23850, 12.93440, 12.55550, 11.92120<span style="color: #907373;">]</span><span style="color: #709870;">]</span>
              , <span style="color: #6434A3;">Age</span> 9.096910
                     <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                     <span style="color: #709870;">[</span>0.103069, 0.113581, 0.125209, 0.141832<span style="color: #709870;">]</span>
                     <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>17.44610, 17.02400, 16.60920, 16.09250<span style="color: #907373;">]</span>
                     , <span style="color: #907373;">[</span>15.36540, 15.02750, 14.69060, 14.26770<span style="color: #907373;">]</span>
                     , <span style="color: #907373;">[</span>13.54260, 13.23130, 12.92070, 12.53310<span style="color: #907373;">]</span><span style="color: #709870;">]</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>
          , <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #709870;">[</span><span style="color: #008000;">"U"</span>, <span style="color: #008000;">"B"</span>, <span style="color: #008000;">"V"</span><span style="color: #709870;">]</span>, <span style="color: #BA36A5;">-</span>1.0, 0.330000<span style="color: #909183;">)</span>
            , <span style="color: #909183;">[</span> <span style="color: #6434A3;">Age</span> 9.0
                    <span style="color: #709870;">[</span>5, 6, 7, 8<span style="color: #709870;">]</span>
                    <span style="color: #709870;">[</span>0.152464, 0.191656, 0.235299, 0.256241<span style="color: #709870;">]</span>
                    <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>15.419500, 14.543400, 13.869200, 13.588700<span style="color: #907373;">]</span>
                    , <span style="color: #907373;">[</span>13.755500, 13.026700, 12.446300, 12.202200<span style="color: #907373;">]</span>
                    , <span style="color: #907373;">[</span>12.094600, 11.447100, 10.926900, 10.706600<span style="color: #907373;">]</span><span style="color: #709870;">]</span>
              , <span style="color: #6434A3;">Age</span> 9.096910
                    <span style="color: #709870;">[</span>5, 6, 7, 8<span style="color: #709870;">]</span>
                    <span style="color: #709870;">[</span>0.128684, 0.153000, 0.191846, 0.232007<span style="color: #709870;">]</span>
                    <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>16.111100, 15.404500, 14.537700, 13.908700<span style="color: #907373;">]</span>
                    , <span style="color: #907373;">[</span>14.322000, 13.743300, 13.021800, 12.480500<span style="color: #907373;">]</span>
                    , <span style="color: #907373;">[</span>12.603800, 12.083700, 11.442800, 10.957500<span style="color: #907373;">]</span><span style="color: #709870;">]</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>
          , <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #709870;">[</span><span style="color: #008000;">"U"</span>, <span style="color: #008000;">"B"</span>, <span style="color: #008000;">"V"</span><span style="color: #709870;">]</span>, <span style="color: #BA36A5;">-</span>0.5, 0.25370<span style="color: #909183;">)</span>
            , <span style="color: #909183;">[</span> <span style="color: #6434A3;">Age</span> 9.0
                    <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                    <span style="color: #709870;">[</span>0.116263, 0.130317, 0.152523, 0.194038<span style="color: #709870;">]</span>
                    <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>16.931000, 16.564000, 16.068000, 15.288200<span style="color: #907373;">]</span>
                    , <span style="color: #907373;">[</span>15.136300, 14.815400, 14.381800, 13.705100<span style="color: #907373;">]</span>
                    , <span style="color: #907373;">[</span>13.420600, 13.116000, 12.706400, 12.077400<span style="color: #907373;">]</span><span style="color: #709870;">]</span>
              , <span style="color: #6434A3;">Age</span> 9.096910
                    <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                    <span style="color: #709870;">[</span>0.104591, 0.116666, 0.131087, 0.153961<span style="color: #709870;">]</span>
                    <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>17.276200, 16.919900, 16.544800, 16.038100<span style="color: #907373;">]</span>
                    , <span style="color: #907373;">[</span>15.436600, 15.126700, 14.798700, 14.355800<span style="color: #907373;">]</span>
                    , <span style="color: #907373;">[</span>13.705400, 13.411400, 13.100200, 12.682000<span style="color: #907373;">]</span><span style="color: #709870;">]</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">]</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# LANGUAGE OverloadedLists, OverloadedStrings #-}</span>
<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Models.SampleConverted</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Vector.Unboxed</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">V</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Models.Input</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.Internal</span>

<span style="color: #006699;">packHeliumFraction</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">HeliumFraction</span>
<span style="color: #006699;">packHeliumFraction</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkHeliumFraction</span> <span style="color: #BA36A5;">.</span> <span style="color: #6434A3;">MkPercentage</span> <span style="color: #BA36A5;">.</span> closedUnitInterval'

<span style="color: #006699;">packFeH</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">FeH</span>
<span style="color: #006699;">packFeH</span>  <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkFeH</span> <span style="color: #BA36A5;">.</span> packLog

<span style="color: #006699;">packAge</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">LogAge</span>
<span style="color: #006699;">packAge</span>  <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkLogAge</span> <span style="color: #BA36A5;">.</span> packLog

<span style="color: #006699;">packMasses</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">V.Vector</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">V.Vector</span> <span style="color: #6434A3;">Mass</span>
<span style="color: #006699;">packMasses</span> <span style="color: #BA36A5;">=</span> V.map <span style="color: #707183;">(</span><span style="color: #6434A3;">MkMass</span> <span style="color: #BA36A5;">.</span> nonNegative'<span style="color: #707183;">)</span>

<span style="color: #006699;">packMags</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">V.Vector</span> <span style="color: #6434A3;">Double</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">V.Vector</span> <span style="color: #6434A3;">AbsoluteMagnitude</span>
<span style="color: #006699;">packMags</span> <span style="color: #BA36A5;">=</span> V.map <span style="color: #707183;">(</span><span style="color: #6434A3;">MkAbsoluteMagnitude</span> <span style="color: #BA36A5;">.</span> packLog<span style="color: #707183;">)</span>


<span style="color: #006699;">convertedDsed</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Model</span>
<span style="color: #006699;">convertedDsed</span> <span style="color: #BA36A5;">=</span>
  <span style="color: #707183;">[</span> <span style="color: #7388D6;">(</span> packFeH <span style="color: #909183;">(</span><span style="color: #BA36A5;">-</span>2.5<span style="color: #909183;">)</span>
    , <span style="color: #909183;">[</span><span style="color: #709870;">(</span> packHeliumFraction 0.2451
       , <span style="color: #907373;">[</span> <span style="color: #6276BA;">(</span>packAge 8.397940, <span style="color: #6434A3;">Isochrone</span> <span style="color: #858580;">[</span>2, 3, 4, 5<span style="color: #858580;">]</span>
                                        <span style="color: #858580;">(</span>packMasses <span style="color: #80A880;">[</span>0.278163, 0.318852, 0.335466, 0.351598<span style="color: #80A880;">]</span><span style="color: #858580;">)</span>
                                        <span style="color: #858580;">[</span> <span style="color: #80A880;">(</span><span style="color: #008000;">"U"</span>, packMags <span style="color: #887070;">[</span>11.7478, 11.3514, 11.2028, 11.0572<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                        , <span style="color: #80A880;">(</span><span style="color: #008000;">"B"</span>, packMags <span style="color: #887070;">[</span>11.0484, 10.7092, 10.5813, 10.4578<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                        , <span style="color: #80A880;">(</span><span style="color: #008000;">"V"</span>, packMags <span style="color: #887070;">[</span>9.8499,  9.5412,  9.4241,  9.3119<span style="color: #887070;">]</span><span style="color: #80A880;">)</span><span style="color: #858580;">]</span><span style="color: #6276BA;">)</span>
         , <span style="color: #6276BA;">(</span>packAge 8.477121, <span style="color: #6434A3;">Isochrone</span> <span style="color: #858580;">[</span>2, 3, 4, 5<span style="color: #858580;">]</span>
                                        <span style="color: #858580;">(</span>packMasses <span style="color: #80A880;">[</span>0.212681, 0.290489, 0.320389, 0.335518<span style="color: #80A880;">]</span><span style="color: #858580;">)</span>
                                        <span style="color: #858580;">[</span> <span style="color: #80A880;">(</span><span style="color: #008000;">"U"</span>, packMags <span style="color: #887070;">[</span>12.5728, 11.6188, 11.3348, 11.2034<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                        , <span style="color: #80A880;">(</span><span style="color: #008000;">"B"</span>, packMags <span style="color: #887070;">[</span>11.7446, 10.9382, 10.6947, 10.5822<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                        , <span style="color: #80A880;">(</span><span style="color: #008000;">"V"</span>, packMags <span style="color: #887070;">[</span>10.4768, 9.7498,  9.5277,  9.4251<span style="color: #887070;">]</span><span style="color: #80A880;">)</span><span style="color: #858580;">]</span><span style="color: #6276BA;">)</span><span style="color: #907373;">]</span><span style="color: #709870;">)</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>
  , <span style="color: #7388D6;">(</span> packFeH <span style="color: #909183;">(</span><span style="color: #BA36A5;">-</span>2.0<span style="color: #909183;">)</span>
    , <span style="color: #909183;">[</span><span style="color: #709870;">(</span> packHeliumFraction 0.2453
       , <span style="color: #907373;">[</span> <span style="color: #6276BA;">(</span>packAge 8.397940, <span style="color: #6434A3;">Isochrone</span> <span style="color: #858580;">[</span>2, 3, 4, 5<span style="color: #858580;">]</span>
                                        <span style="color: #858580;">(</span>packMasses <span style="color: #80A880;">[</span>0.297801, 0.335484, 0.338823, 0.355097<span style="color: #80A880;">]</span><span style="color: #858580;">)</span>
                                        <span style="color: #858580;">[</span> <span style="color: #80A880;">(</span><span style="color: #008000;">"U"</span>, packMags <span style="color: #887070;">[</span>12.1589, 11.8031, 11.7674, 11.5974<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                        , <span style="color: #80A880;">(</span><span style="color: #008000;">"B"</span>, packMags <span style="color: #887070;">[</span>11.2562, 10.9432, 10.9126, 10.7646<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                        , <span style="color: #80A880;">(</span><span style="color: #008000;">"V"</span>, packMags <span style="color: #887070;">[</span>9.9655,  9.6821,  9.6546,  9.5203<span style="color: #887070;">]</span><span style="color: #80A880;">)</span><span style="color: #858580;">]</span><span style="color: #6276BA;">)</span>
         , <span style="color: #6276BA;">(</span>packAge 8.477121, <span style="color: #6434A3;">Isochrone</span> <span style="color: #858580;">[</span>2, 3, 4, 5<span style="color: #858580;">]</span>
                                        <span style="color: #858580;">(</span>packMasses <span style="color: #80A880;">[</span>0.251276, 0.317207, 0.335075, 0.337718<span style="color: #80A880;">]</span><span style="color: #858580;">)</span>
                                        <span style="color: #858580;">[</span> <span style="color: #80A880;">(</span><span style="color: #008000;">"U"</span>, packMags <span style="color: #887070;">[</span>12.6621, 11.9778, 11.8076, 11.7862<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                        , <span style="color: #80A880;">(</span><span style="color: #008000;">"B"</span>, packMags <span style="color: #887070;">[</span>11.6918, 11.0959, 10.9477, 10.9296<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                        , <span style="color: #80A880;">(</span><span style="color: #008000;">"V"</span>, packMags <span style="color: #887070;">[</span>10.3548, 9.8205,  9.6866,  9.6705<span style="color: #887070;">]</span><span style="color: #80A880;">)</span><span style="color: #858580;">]</span><span style="color: #6276BA;">)</span><span style="color: #907373;">]</span><span style="color: #709870;">)</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">]</span>


<span style="color: #006699;">convertedNewDsed</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Model</span>
<span style="color: #006699;">convertedNewDsed</span> <span style="color: #BA36A5;">=</span>
  <span style="color: #707183;">[</span> <span style="color: #7388D6;">(</span> packFeH <span style="color: #909183;">(</span><span style="color: #BA36A5;">-</span>1.0<span style="color: #909183;">)</span>
    , <span style="color: #909183;">[</span> <span style="color: #709870;">(</span> packHeliumFraction 0.247800
        , <span style="color: #907373;">[</span> <span style="color: #6276BA;">(</span>packAge 9.000000, <span style="color: #6434A3;">Isochrone</span> <span style="color: #858580;">[</span>2, 3, 4, 5<span style="color: #858580;">]</span>
                                         <span style="color: #858580;">(</span>packMasses <span style="color: #80A880;">[</span>0.113315, 0.124680, 0.140813, 0.173692<span style="color: #80A880;">]</span><span style="color: #858580;">)</span>
                                         <span style="color: #858580;">[</span> <span style="color: #80A880;">(</span><span style="color: #008000;">"U"</span>, packMags <span style="color: #887070;">[</span>17.03370, 16.62740, 16.12280, 15.25250<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"B"</span>, packMags <span style="color: #887070;">[</span>15.03530, 14.70540, 14.29240, 13.58510<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"V"</span>, packMags <span style="color: #887070;">[</span>13.23850, 12.93440, 12.55550, 11.92120<span style="color: #887070;">]</span><span style="color: #80A880;">)</span><span style="color: #858580;">]</span><span style="color: #6276BA;">)</span>
          , <span style="color: #6276BA;">(</span>packAge 9.096910, <span style="color: #6434A3;">Isochrone</span> <span style="color: #858580;">[</span>2, 3, 4, 5<span style="color: #858580;">]</span>
                                         <span style="color: #858580;">(</span>packMasses <span style="color: #80A880;">[</span>0.103069, 0.113581, 0.125209, 0.141832<span style="color: #80A880;">]</span><span style="color: #858580;">)</span>
                                         <span style="color: #858580;">[</span> <span style="color: #80A880;">(</span><span style="color: #008000;">"U"</span>, packMags <span style="color: #887070;">[</span>17.44610, 17.02400, 16.60920, 16.09250<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"B"</span>, packMags <span style="color: #887070;">[</span>15.36540, 15.02750, 14.69060, 14.26770<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"V"</span>, packMags <span style="color: #887070;">[</span>13.54260, 13.23130, 12.92070, 12.53310<span style="color: #887070;">]</span><span style="color: #80A880;">)</span><span style="color: #858580;">]</span><span style="color: #6276BA;">)</span><span style="color: #907373;">]</span><span style="color: #709870;">)</span>
      , <span style="color: #709870;">(</span> packHeliumFraction 0.33
        , <span style="color: #907373;">[</span> <span style="color: #6276BA;">(</span>packAge 9.000000, <span style="color: #6434A3;">Isochrone</span> <span style="color: #858580;">[</span>5, 6, 7, 8<span style="color: #858580;">]</span>
                                         <span style="color: #858580;">(</span>packMasses <span style="color: #80A880;">[</span>0.152464, 0.191656, 0.235299, 0.256241<span style="color: #80A880;">]</span><span style="color: #858580;">)</span>
                                         <span style="color: #858580;">[</span> <span style="color: #80A880;">(</span><span style="color: #008000;">"U"</span>, packMags <span style="color: #887070;">[</span>15.419500, 14.543400, 13.869200, 13.588700<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"B"</span>, packMags <span style="color: #887070;">[</span>13.755500, 13.026700, 12.446300, 12.202200<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"V"</span>, packMags  <span style="color: #887070;">[</span>12.094600, 11.447100, 10.926900, 10.706600<span style="color: #887070;">]</span><span style="color: #80A880;">)</span><span style="color: #858580;">]</span><span style="color: #6276BA;">)</span>
          , <span style="color: #6276BA;">(</span>packAge 9.096910, <span style="color: #6434A3;">Isochrone</span> <span style="color: #858580;">[</span>5, 6, 7, 8<span style="color: #858580;">]</span>
                                         <span style="color: #858580;">(</span>packMasses <span style="color: #80A880;">[</span>0.128684, 0.153000, 0.191846, 0.232007<span style="color: #80A880;">]</span><span style="color: #858580;">)</span>
                                         <span style="color: #858580;">[</span> <span style="color: #80A880;">(</span><span style="color: #008000;">"U"</span>, packMags <span style="color: #887070;">[</span>16.111100, 15.404500, 14.537700, 13.908700<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"B"</span>, packMags <span style="color: #887070;">[</span>14.322000, 13.743300, 13.021800, 12.480500<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"V"</span>, packMags <span style="color: #887070;">[</span>12.603800, 12.083700, 11.442800, 10.957500<span style="color: #887070;">]</span><span style="color: #80A880;">)</span><span style="color: #858580;">]</span><span style="color: #6276BA;">)</span><span style="color: #907373;">]</span><span style="color: #709870;">)</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>
  , <span style="color: #7388D6;">(</span> packFeH <span style="color: #909183;">(</span><span style="color: #BA36A5;">-</span>0.5<span style="color: #909183;">)</span>
    , <span style="color: #909183;">[</span> <span style="color: #709870;">(</span> packHeliumFraction 0.25370
        , <span style="color: #907373;">[</span> <span style="color: #6276BA;">(</span>packAge 9.000000, <span style="color: #6434A3;">Isochrone</span> <span style="color: #858580;">[</span>2, 3, 4, 5<span style="color: #858580;">]</span>
                                         <span style="color: #858580;">(</span>packMasses <span style="color: #80A880;">[</span>0.116263, 0.130317, 0.152523, 0.194038<span style="color: #80A880;">]</span><span style="color: #858580;">)</span>
                                         <span style="color: #858580;">[</span> <span style="color: #80A880;">(</span><span style="color: #008000;">"U"</span>, packMags <span style="color: #887070;">[</span>16.931000, 16.564000, 16.068000, 15.288200<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"B"</span>, packMags <span style="color: #887070;">[</span>15.136300, 14.815400, 14.381800, 13.705100<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"V"</span>, packMags <span style="color: #887070;">[</span>13.420600, 13.116000, 12.706400, 12.077400<span style="color: #887070;">]</span><span style="color: #80A880;">)</span><span style="color: #858580;">]</span><span style="color: #6276BA;">)</span>
          , <span style="color: #6276BA;">(</span>packAge 9.096910, <span style="color: #6434A3;">Isochrone</span> <span style="color: #858580;">[</span>2, 3, 4, 5<span style="color: #858580;">]</span>
                                         <span style="color: #858580;">(</span>packMasses <span style="color: #80A880;">[</span>0.104591, 0.116666, 0.131087, 0.153961<span style="color: #80A880;">]</span><span style="color: #858580;">)</span>
                                         <span style="color: #858580;">[</span> <span style="color: #80A880;">(</span><span style="color: #008000;">"U"</span>, packMags <span style="color: #887070;">[</span>17.276200, 16.919900, 16.544800, 16.038100<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"B"</span>, packMags <span style="color: #887070;">[</span>15.436600, 15.126700, 14.798700, 14.355800<span style="color: #887070;">]</span><span style="color: #80A880;">)</span>
                                         , <span style="color: #80A880;">(</span><span style="color: #008000;">"V"</span>, packMags <span style="color: #887070;">[</span>13.705400, 13.411400, 13.100200, 12.682000<span style="color: #887070;">]</span><span style="color: #80A880;">)</span><span style="color: #858580;">]</span><span style="color: #6276BA;">)</span><span style="color: #907373;">]</span><span style="color: #709870;">)</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0911221" class="outline-3">
<h3 id="org0911221"><span class="section-number-3">1.6.</span> <code>makeIsochrone</code> tool</h3>
<div class="outline-text-3" id="text-1-6">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# LANGUAGE TypeApplications #-}</span>
<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Main</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Map</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">M</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Options.Applicative</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Vector</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Vector</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Vector</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">V</span>
<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Vector.Unboxed</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">U</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Text.Printf</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Models.Input</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.Internal</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Interpolate</span>

<span style="color: #006699;">clusterParser</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Parser</span> <span style="color: #6434A3;">Cluster</span>
<span style="color: #006699;">clusterParser</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Cluster</span>
                <span style="color: #BA36A5;">&lt;$&gt;</span> option <span style="color: #707183;">(</span>maybeReader <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Just</span> <span style="color: #BA36A5;">.</span> <span style="color: #6434A3;">MkFeH</span> <span style="color: #BA36A5;">.</span> packLog <span style="color: #BA36A5;">.</span> read<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                      <span style="color: #707183;">(</span>long <span style="color: #008000;">"cluster-feh"</span>
                       <span style="color: #BA36A5;">&lt;&gt;</span> metavar <span style="color: #008000;">"FEH"</span>
                       <span style="color: #BA36A5;">&lt;&gt;</span> help <span style="color: #008000;">"Specify cluster FeH"</span><span style="color: #707183;">)</span>
                <span style="color: #BA36A5;">&lt;*&gt;</span> option <span style="color: #707183;">(</span>maybeReader <span style="color: #7388D6;">(</span>fmap <span style="color: #909183;">(</span><span style="color: #6434A3;">MkHeliumFraction</span> <span style="color: #BA36A5;">.</span> <span style="color: #6434A3;">MkPercentage</span><span style="color: #909183;">)</span> <span style="color: #BA36A5;">.</span> closedUnitInterval <span style="color: #BA36A5;">.</span> read<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                      <span style="color: #707183;">(</span>long <span style="color: #008000;">"cluster-y"</span>
                       <span style="color: #BA36A5;">&lt;&gt;</span> metavar <span style="color: #008000;">"Y"</span>
                       <span style="color: #BA36A5;">&lt;&gt;</span> help <span style="color: #008000;">"Specify cluster Y"</span><span style="color: #707183;">)</span>
                <span style="color: #BA36A5;">&lt;*&gt;</span> option <span style="color: #707183;">(</span>maybeReader <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Just</span> <span style="color: #BA36A5;">.</span> <span style="color: #6434A3;">MkLogAge</span> <span style="color: #BA36A5;">.</span> packLog <span style="color: #BA36A5;">.</span> read<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                      <span style="color: #707183;">(</span>long <span style="color: #008000;">"cluster-age"</span>
                       <span style="color: #BA36A5;">&lt;&gt;</span> metavar <span style="color: #008000;">"AGE"</span>
                       <span style="color: #BA36A5;">&lt;&gt;</span> help <span style="color: #008000;">"Specify cluster age in log years"</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">data</span> <span style="color: #6434A3;">MakeIsochroneOptions</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MakeIsochroneOptions</span>
  <span style="color: #707183;">{</span> cluster   <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Cluster</span>
  , modelName <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">MSModel</span> <span style="color: #707183;">}</span>


<span style="color: #006699;">makeIsochroneOptionParser</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Parser</span> <span style="color: #6434A3;">MakeIsochroneOptions</span>
<span style="color: #006699;">makeIsochroneOptionParser</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MakeIsochroneOptions</span> <span style="color: #BA36A5;">&lt;$&gt;</span> clusterParser
                                                 <span style="color: #BA36A5;">&lt;*&gt;</span> option auto
                                                            <span style="color: #707183;">(</span>long <span style="color: #008000;">"model"</span>
                                                             <span style="color: #BA36A5;">&lt;&gt;</span> metavar <span style="color: #008000;">"MODEL"</span>
                                                             <span style="color: #BA36A5;">&lt;&gt;</span> help <span style="color: #008000;">"Specify model. One of: {OldDsed, NewDsed}"</span><span style="color: #707183;">)</span>


<span style="color: #006699;">main</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">IO</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">main</span> <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span> options <span style="color: #BA36A5;">&lt;-</span> execParser opts
          models  <span style="color: #BA36A5;">&lt;-</span> convertModels <span style="color: #BA36A5;">&lt;$&gt;</span> loadModels <span style="color: #707183;">(</span>modelName <span style="color: #BA36A5;">$</span> options<span style="color: #707183;">)</span>
          <span style="color: #0000FF;">let</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Isochrone</span> eeps masses magnitudes<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> interpolateIsochrone <span style="color: #707183;">(</span>cluster options<span style="color: #707183;">)</span> models
              filters <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">case</span> M.elems magnitudes <span style="color: #0000FF;">of</span>
                     <span style="color: #707183;">(</span>ms<span style="color: #6434A3;">:</span><span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> V.fromList <span style="color: #BA36A5;">$</span> map <span style="color: #707183;">(</span><span style="color: #BA36A5;">\</span>i <span style="color: #BA36A5;">-&gt;</span> concatMap <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">\</span>v <span style="color: #BA36A5;">-&gt;</span> printf <span style="color: #008000;">" %0.6f"</span> <span style="color: #909183;">(</span>unpackLog <span style="color: #BA36A5;">.</span> unAbsoluteMagnitude <span style="color: #BA36A5;">$</span> v <span style="color: #BA36A5;">U.!</span> i<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #BA36A5;">$</span> M.elems magnitudes<span style="color: #707183;">)</span> <span style="color: #707183;">[</span>0<span style="color: #BA36A5;">..</span> <span style="color: #7388D6;">(</span>U.length ms <span style="color: #BA36A5;">-</span> 1<span style="color: #7388D6;">)</span><span style="color: #707183;">]</span>
                     <span style="color: #0000FF;">_</span>      <span style="color: #BA36A5;">-&gt;</span> mempty

          mapM_ <span style="color: #707183;">(</span>printf <span style="color: #008000;">"%s "</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">$</span> M.keys magnitudes
          putStrLn <span style="color: #008000;">""</span>
          V.mapM_ <span style="color: #707183;">(</span><span style="color: #BA36A5;">\</span><span style="color: #7388D6;">(</span>a, b, c<span style="color: #7388D6;">)</span> <span style="color: #BA36A5;">-&gt;</span> printf <span style="color: #008000;">"%d %0.6f%s\n"</span> a b c<span style="color: #707183;">)</span> <span style="color: #BA36A5;">$</span>
            V.zip3 <span style="color: #707183;">(</span>V.convert eeps<span style="color: #707183;">)</span>
                   <span style="color: #707183;">(</span>V.map <span style="color: #7388D6;">(</span>unNonNegative <span style="color: #BA36A5;">.</span> unMass<span style="color: #7388D6;">)</span> <span style="color: #BA36A5;">.</span> V.convert <span style="color: #BA36A5;">$</span> masses<span style="color: #707183;">)</span>
                   <span style="color: #707183;">(</span>filters <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Vector</span> <span style="color: #6434A3;">String</span><span style="color: #707183;">)</span>

  <span style="color: #0000FF;">where</span>
    opts <span style="color: #BA36A5;">=</span> info <span style="color: #707183;">(</span>makeIsochroneOptionParser <span style="color: #BA36A5;">&lt;**&gt;</span> helper<span style="color: #707183;">)</span>
      <span style="color: #707183;">(</span> fullDesc
     <span style="color: #BA36A5;">&lt;&gt;</span> progDesc <span style="color: #008000;">"Generate an isochrone from the models based on cluster parameters"</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6e0db43" class="outline-3">
<h3 id="org6e0db43"><span class="section-number-3">1.7.</span> Benchmark</h3>
<div class="outline-text-3" id="text-1-7">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Criterion.Main</span>

<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Map.Strict</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">M</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Interpolate</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Models.Input</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Types.Internal</span>

<span style="color: #8D8D84;">-- </span><span style="color: #8D8D84; font-style: italic;">Our benchmark harness.</span>
<span style="color: #006699;">main</span> <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span>
  model <span style="color: #BA36A5;">&lt;-</span> loadModels <span style="color: #6434A3;">NewDsed</span>
  <span style="color: #0000FF;">let</span> i1 <span style="color: #BA36A5;">=</span> snd <span style="color: #BA36A5;">.</span> M.findMin <span style="color: #BA36A5;">.</span> snd <span style="color: #BA36A5;">.</span> M.findMin <span style="color: #BA36A5;">.</span> snd <span style="color: #BA36A5;">.</span> M.findMin <span style="color: #BA36A5;">.</span> convertModels <span style="color: #BA36A5;">$</span> model
      i2 <span style="color: #BA36A5;">=</span> snd <span style="color: #BA36A5;">.</span> M.findMax <span style="color: #BA36A5;">.</span> snd <span style="color: #BA36A5;">.</span> M.findMax <span style="color: #BA36A5;">.</span> snd <span style="color: #BA36A5;">.</span> M.findMin <span style="color: #BA36A5;">.</span> convertModels <span style="color: #BA36A5;">$</span> model

  defaultMain <span style="color: #707183;">[</span>
    bench <span style="color: #008000;">"convertModels"</span> <span style="color: #BA36A5;">$</span> whnf convertModels model,
    bench <span style="color: #008000;">"interpolateIsochrones"</span> <span style="color: #BA36A5;">$</span> whnf <span style="color: #7388D6;">(</span>interpolateIsochrones <span style="color: #909183;">(</span>closedUnitInterval' 0.5<span style="color: #909183;">)</span> i1<span style="color: #7388D6;">)</span> i2,
    bgroup <span style="color: #008000;">"convertModels"</span> <span style="color: #7388D6;">[]</span><span style="color: #707183;">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org22ca289" class="outline-3">
<h3 id="org22ca289"><span class="section-number-3">1.8.</span> Artifacts</h3>
<div class="outline-text-3" id="text-1-8">
</div>
<div id="outline-container-org23fe10c" class="outline-4">
<h4 id="org23fe10c"><span class="section-number-4">1.8.1.</span> Cabal config</h4>
<div class="outline-text-4" id="text-1-8-1">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">name</span>: BayesianStellarEvolution
<span style="color: #BA36A5;">category</span>: application
<span style="color: #BA36A5;">author</span>: Elliot Robinson
<span style="color: #BA36A5;">maintainer</span>: elliot.robinson@rgoptech.com
<span style="color: #BA36A5;">copyright</span>: <span style="color: #008000;">'2019'</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">license:</span>
<span style="color: #BA36A5;">github</span>: BayesianStellarEvolution/BayesianStellarEvolution

<span style="color: #BA36A5;">default-extensions</span>:
  - OverloadedStrings
  - BangPatterns

<span style="color: #BA36A5;">ghc-options</span>:
  - -Wall
  
<span style="color: #BA36A5;">library</span>:
  <span style="color: #BA36A5;">source-dirs</span>: src

  <span style="color: #BA36A5;">exposed-modules</span>:
    - Models.Input
    - Models.Sample
    - Models.SampleConverted
    - Interpolate
    - Types
    - Types.DistanceMeasures
    - Types.Magnitude
    - Types.Internal

  <span style="color: #BA36A5;">dependencies</span>:
    - base &gt;=4.10 &amp;&amp; &lt;5
    - BayesianStellarEvolution-Models
    - attoparsec
    - bytestring
    - conduit
    - conduit-extra
    - containers
    - ghc-compact
    - lzma-conduit
    - math-functions
    - optparse-applicative
    - QuickCheck
    - text
    - vector
    - vector-th-unbox

<span style="color: #BA36A5;">executables</span>:
  <span style="color: #BA36A5;">makeIsochrone</span>:
    <span style="color: #BA36A5;">main</span>: Main.hs
    <span style="color: #BA36A5;">source-dirs</span>: makeIsochrone

    <span style="color: #BA36A5;">dependencies</span>:
      - base
      - BayesianStellarEvolution
      - containers
      - optparse-applicative
      - vector

<span style="color: #BA36A5;">tests</span>:
  <span style="color: #BA36A5;">library-tests</span>:
    <span style="color: #BA36A5;">main</span>: Spec.hs
    <span style="color: #BA36A5;">source-dirs</span>: test

    <span style="color: #BA36A5;">ghc-options</span>:
      - -threaded
      - -rtsopts
      - -with-rtsopts=-N

    <span style="color: #BA36A5;">dependencies</span>:
      - base
      - BayesianStellarEvolution
      - attoparsec
      - bytestring
      - conduit
      - containers
      - hspec
      - QuickCheck
      - raw-strings-qq
      - vector


<span style="color: #BA36A5;">benchmarks</span>:
  <span style="color: #BA36A5;">library-benchmarks</span>:
    <span style="color: #BA36A5;">main</span>: Main.hs
    <span style="color: #BA36A5;">source-dirs</span>: bench

    <span style="color: #BA36A5;">ghc-options</span>:
      - -threaded
      - -rtsopts
      - -with-rtsopts=-N
 
    <span style="color: #BA36A5;">dependencies</span>:
      - base
      - BayesianStellarEvolution
      - containers
      - criterion
      - vector
</pre>
</div>
</div>
</div>

<div id="outline-container-org16b3e0b" class="outline-4">
<h4 id="org16b3e0b"><span class="section-number-4">1.8.2.</span> Test spec finder</h4>
<div class="outline-text-4" id="text-1-8-2">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #BA36A5;">&lt;&lt;</span>test spec finder<span style="color: #BA36A5;">&gt;&gt;</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org98bb1c8" class="outline-2">
<h2 id="org98bb1c8"><span class="section-number-2">2.</span> Photometric Model library</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# LANGUAGE QuasiQuotes, OverloadedLists #-}</span>
<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">MainSequenceModelSpec</span> <span style="color: #707183;">(</span>main, spec<span style="color: #707183;">)</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Conduit</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Attoparsec.ByteString</span> <span style="color: #707183;">(</span>parseOnly<span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Either</span> <span style="color: #707183;">(</span>isLeft, isRight<span style="color: #707183;">)</span>

<span style="color: #0000FF;">import</span>           <span style="color: #6434A3;">Data.ByteString</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">ByteString</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.ByteString.Char8</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">B</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Test.Hspec</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Text.RawString.QQ</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">MainSequenceModel</span>


<span style="color: #006699;">main</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">IO</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">main</span> <span style="color: #BA36A5;">=</span> hspec spec

<span style="color: #006699;">spec</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">SpecWith</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">spec</span> <span style="color: #BA36A5;">=</span> parallel <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
  describe <span style="color: #008000;">"MS Model file format"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
    describe <span style="color: #008000;">"taggedDouble"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      <span style="color: #0000FF;">let</span> doParse <span style="color: #BA36A5;">=</span> parseOnly <span style="color: #BA36A5;">$</span> taggedDouble <span style="color: #008000;">"tag="</span>

      it <span style="color: #008000;">"pulls a double given a tag"</span> <span style="color: #BA36A5;">$</span>
        doParse <span style="color: #008000;">" tag=1.00"</span> <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #6434A3;">Right</span> 1.00

      it <span style="color: #008000;">"requires at lease one space in the source string prior to the tag"</span> <span style="color: #BA36A5;">$</span>
        doParse <span style="color: #008000;">"tag=1.00"</span> <span style="color: #BA36A5;">`shouldSatisfy`</span> isLeft

    describe <span style="color: #008000;">"Filters"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      <span style="color: #0000FF;">let</span> doParse <span style="color: #BA36A5;">=</span> parseOnly parseFilters

      it <span style="color: #008000;">"parses a single filter"</span> <span style="color: #BA36A5;">$</span>
        doParse <span style="color: #008000;">" U\n"</span> <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Right</span> <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">Filters</span> <span style="color: #7388D6;">[</span><span style="color: #008000;">"U"</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>

      it <span style="color: #008000;">"parses a list of filters"</span> <span style="color: #BA36A5;">$</span>
        doParse <span style="color: #008000;">" U B V R I J H K\n"</span> <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Right</span> <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">Filters</span> <span style="color: #7388D6;">[</span><span style="color: #008000;">"U"</span>, <span style="color: #008000;">"B"</span>, <span style="color: #008000;">"V"</span>, <span style="color: #008000;">"R"</span>, <span style="color: #008000;">"I"</span>, <span style="color: #008000;">"J"</span>, <span style="color: #008000;">"H"</span>, <span style="color: #008000;">"K"</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>


    describe <span style="color: #008000;">"MS Model section header"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      <span style="color: #0000FF;">let</span> doParse <span style="color: #BA36A5;">=</span> parseOnly parseSectionHeader

      it <span style="color: #008000;">"parses a section header"</span> <span style="color: #BA36A5;">$</span>
        <span style="color: #0000FF;">let</span> result <span style="color: #BA36A5;">=</span> doParse <span style="color: #008000;">" [Fe/H]=-2.500000    [alpha/Fe]=0.000000    l/Hp=1.938000    Y=0.245100\n"</span>
        <span style="color: #0000FF;">in</span> result <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Right</span> <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">SectionHeader</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">-</span>2.5<span style="color: #7388D6;">)</span> 0.0 1.938 0.2451<span style="color: #707183;">)</span>

    describe <span style="color: #008000;">"MS Model age header"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      <span style="color: #0000FF;">let</span> doParse <span style="color: #BA36A5;">=</span> parseOnly parseAgeHeader

      it <span style="color: #008000;">"parses an age header"</span> <span style="color: #BA36A5;">$</span>
        <span style="color: #0000FF;">let</span> result <span style="color: #BA36A5;">=</span> doParse <span style="color: #008000;">" logAge=8.397940\n"</span>
        <span style="color: #0000FF;">in</span> result <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Right</span> <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">AgeHeader</span> 8.397940<span style="color: #707183;">)</span>


    describe <span style="color: #008000;">"MS Model EEP"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      <span style="color: #0000FF;">let</span> doParse <span style="color: #BA36A5;">=</span> parseOnly parseEEP <span style="color: #008000;">"    2 0.278163 11.747800 11.048400  9.849900\n"</span>

      it <span style="color: #008000;">"parses an EEP line"</span> <span style="color: #BA36A5;">$</span>
        doParse <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Right</span> <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">EEP</span> 2 0.278163 <span style="color: #7388D6;">[</span>11.7478, 11.0484, 9.8499<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>


    describe <span style="color: #008000;">"Comments"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      <span style="color: #0000FF;">let</span> desired <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Right</span> <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">Comment</span> <span style="color: #008000;">"any text here"</span>
          doParse <span style="color: #BA36A5;">=</span> parseOnly parseComment

      it <span style="color: #008000;">"captures a comment with no space after #"</span> <span style="color: #BA36A5;">$</span>
        doParse <span style="color: #008000;">"any text here\n"</span> <span style="color: #BA36A5;">`shouldBe`</span> desired
      it <span style="color: #008000;">"skips space after #"</span> <span style="color: #BA36A5;">$</span>
        doParse <span style="color: #008000;">"\t any text here\n"</span> <span style="color: #BA36A5;">`shouldBe`</span> desired


    describe <span style="color: #008000;">"Model"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      it <span style="color: #008000;">"lexes"</span> <span style="color: #BA36A5;">$</span>
        <span style="color: #0000FF;">let</span> result <span style="color: #BA36A5;">=</span> sequence <span style="color: #BA36A5;">$</span> map <span style="color: #707183;">(</span>fmap snd<span style="color: #707183;">)</span> <span style="color: #BA36A5;">$</span> runConduitPure <span style="color: #BA36A5;">$</span> yield dsed <span style="color: #BA36A5;">.|</span> lexModel <span style="color: #BA36A5;">.|</span> sinkList
            expected <span style="color: #BA36A5;">=</span> <span style="color: #707183;">[</span> <span style="color: #6434A3;">Comment</span> <span style="color: #008000;">"(abbreviated) DSED models"</span>
                       , <span style="color: #6434A3;">Filters</span> <span style="color: #7388D6;">[</span><span style="color: #008000;">"U"</span>, <span style="color: #008000;">"B"</span><span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">Filters</span> <span style="color: #7388D6;">[</span><span style="color: #008000;">"V"</span><span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">SectionHeader</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">-</span>2.5<span style="color: #7388D6;">)</span> 0 1.938 0.2451
                       , <span style="color: #6434A3;">AgeHeader</span> 8.39794
                       , <span style="color: #6434A3;">Comment</span> <span style="color: #008000;">"EEP     Mass         U         B         V"</span>
                       , <span style="color: #6434A3;">EEP</span> 2 0.278163 <span style="color: #7388D6;">[</span>11.7478, 11.0484, 9.8499<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 3 0.318852 <span style="color: #7388D6;">[</span>11.3514, 10.7092, 9.5412<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 4 0.335466 <span style="color: #7388D6;">[</span>11.2028, 10.5813, 9.4241<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 5 0.351598 <span style="color: #7388D6;">[</span>11.0572, 10.4578, 9.3119<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">AgeHeader</span> 8.477121
                       , <span style="color: #6434A3;">Comment</span> <span style="color: #008000;">"EEP     Mass         U         B         V"</span>
                       , <span style="color: #6434A3;">EEP</span> 2 0.212681 <span style="color: #7388D6;">[</span>12.5728, 11.7446, 10.4768<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 3 0.290489 <span style="color: #7388D6;">[</span>11.6188, 10.9382,  9.7498<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 4 0.320389 <span style="color: #7388D6;">[</span>11.3348, 10.6947,  9.5277<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 5 0.335518 <span style="color: #7388D6;">[</span>11.2034, 10.5822,  9.4251<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">Comment</span> <span style="color: #008000;">""</span>

                       , <span style="color: #6434A3;">SectionHeader</span> <span style="color: #7388D6;">(</span><span style="color: #BA36A5;">-</span>2.0<span style="color: #7388D6;">)</span> 0.0 1.938 0.2453
                       , <span style="color: #6434A3;">AgeHeader</span> 8.397940
                       , <span style="color: #6434A3;">Comment</span> <span style="color: #008000;">"EEP     Mass         U         B         V"</span>
                       , <span style="color: #6434A3;">EEP</span> 2 0.297801 <span style="color: #7388D6;">[</span>12.1589, 11.2562, 9.9655<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 3 0.335484 <span style="color: #7388D6;">[</span>11.8031, 10.9432, 9.6821<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 4 0.338823 <span style="color: #7388D6;">[</span>11.7674, 10.9126, 9.6546<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 5 0.355097 <span style="color: #7388D6;">[</span>11.5974, 10.7646, 9.5203<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">AgeHeader</span> 8.477121
                       , <span style="color: #6434A3;">Comment</span> <span style="color: #008000;">""</span>
                       , <span style="color: #6434A3;">Comment</span> <span style="color: #008000;">"EEP     Mass         U         B         V"</span>
                       , <span style="color: #6434A3;">EEP</span> 2 0.251276 <span style="color: #7388D6;">[</span>12.6621, 11.6918, 10.3548<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 3 0.317207 <span style="color: #7388D6;">[</span>11.9778, 11.0959,  9.8205<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 4 0.335075 <span style="color: #7388D6;">[</span>11.8076, 10.9477,  9.6866<span style="color: #7388D6;">]</span>
                       , <span style="color: #6434A3;">EEP</span> 5 0.337718 <span style="color: #7388D6;">[</span>11.7862, 10.9296,  9.6705<span style="color: #7388D6;">]</span><span style="color: #707183;">]</span>
        <span style="color: #0000FF;">in</span> <span style="color: #707183;">(</span>result <span style="color: #BA36A5;">`shouldSatisfy`</span> isRight<span style="color: #707183;">)</span> <span style="color: #BA36A5;">&gt;&gt;</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span><span style="color: #BA36A5;">\</span><span style="color: #909183;">(</span><span style="color: #6434A3;">Right</span> r<span style="color: #909183;">)</span> <span style="color: #BA36A5;">-&gt;</span> r<span style="color: #7388D6;">)</span> result <span style="color: #BA36A5;">`shouldBe`</span> expected<span style="color: #707183;">)</span>

      it <span style="color: #008000;">"parses"</span> <span style="color: #BA36A5;">$</span>
        <span style="color: #0000FF;">let</span> result <span style="color: #BA36A5;">=</span> runConduitPure <span style="color: #BA36A5;">$</span> yield dsed <span style="color: #BA36A5;">.|</span> lexModel <span style="color: #BA36A5;">.|</span> parseModel <span style="color: #BA36A5;">.|</span> sinkList
        <span style="color: #0000FF;">in</span> result <span style="color: #BA36A5;">`shouldBe`</span> <span style="color: #707183;">[</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #709870;">[</span><span style="color: #008000;">"U"</span>, <span style="color: #008000;">"B"</span>, <span style="color: #008000;">"V"</span><span style="color: #709870;">]</span>, <span style="color: #BA36A5;">-</span>2.5, 0.2451<span style="color: #909183;">)</span>,
                                 <span style="color: #909183;">[</span> <span style="color: #6434A3;">Age</span> 8.39794
                                       <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                                       <span style="color: #709870;">[</span>0.278163, 0.318852, 0.335466, 0.351598<span style="color: #709870;">]</span>
                                       <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>11.7478, 11.3514, 11.2028, 11.0572<span style="color: #907373;">]</span>
                                       , <span style="color: #907373;">[</span>11.0484, 10.7092, 10.5813, 10.4578<span style="color: #907373;">]</span>
                                       , <span style="color: #907373;">[</span>9.8499,  9.5412,  9.4241,  9.3119<span style="color: #907373;">]</span><span style="color: #709870;">]</span>
                                 , <span style="color: #6434A3;">Age</span> 8.477121
                                       <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                                       <span style="color: #709870;">[</span>0.212681, 0.290489, 0.320389, 0.335518<span style="color: #709870;">]</span>
                                       <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>12.5728, 11.6188, 11.3348, 11.2034<span style="color: #907373;">]</span>
                                       , <span style="color: #907373;">[</span>11.7446, 10.9382, 10.6947, 10.5822<span style="color: #907373;">]</span>
                                       , <span style="color: #907373;">[</span>10.4768, 9.7498,  9.5277,  9.4251<span style="color: #907373;">]</span><span style="color: #709870;">]</span> <span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>
                             , <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #709870;">[</span><span style="color: #008000;">"U"</span>, <span style="color: #008000;">"B"</span>, <span style="color: #008000;">"V"</span><span style="color: #709870;">]</span>, <span style="color: #BA36A5;">-</span>2.0, 0.2453<span style="color: #909183;">)</span>,
                                 <span style="color: #909183;">[</span> <span style="color: #6434A3;">Age</span> 8.397940
                                       <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                                       <span style="color: #709870;">[</span>0.297801, 0.335484, 0.338823, 0.355097<span style="color: #709870;">]</span>
                                       <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>12.1589, 11.8031, 11.7674, 11.5974<span style="color: #907373;">]</span>
                                       , <span style="color: #907373;">[</span>11.2562, 10.9432, 10.9126, 10.7646<span style="color: #907373;">]</span>
                                       , <span style="color: #907373;">[</span>9.9655,  9.6821,  9.6546,  9.5203<span style="color: #907373;">]</span><span style="color: #709870;">]</span>
                                 , <span style="color: #6434A3;">Age</span> 8.477121
                                       <span style="color: #709870;">[</span>2, 3, 4, 5<span style="color: #709870;">]</span>
                                       <span style="color: #709870;">[</span>0.251276, 0.317207, 0.335075, 0.337718<span style="color: #709870;">]</span>
                                       <span style="color: #709870;">[</span> <span style="color: #907373;">[</span>12.6621, 11.9778, 11.8076, 11.7862<span style="color: #907373;">]</span>
                                       , <span style="color: #907373;">[</span>11.6918, 11.0959, 10.9477, 10.9296<span style="color: #907373;">]</span>
                                       , <span style="color: #907373;">[</span>10.3548, 9.8205,  9.6866,  9.6705<span style="color: #907373;">]</span><span style="color: #709870;">]</span> <span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">]</span>

<span style="color: #BA36A5;">&lt;&lt;</span><span style="color: #6434A3;">DSED</span> raw<span style="color: #BA36A5;">&gt;&gt;</span>
</pre>
</div>

<p>
This quasiquote breaks HTML export, reason unknown. ( FIXME )
</p>

<div class="org-src-container">
<pre class="src src-text">dsed :: ByteString
dsed = B.pack $ [r|# (abbreviated) DSED models
%f U B
%f V
%s [Fe/H]=-2.500000    [alpha/Fe]=0.000000    l/Hp=1.938000    Y=0.245100
%a logAge=8.397940
# EEP     Mass         U         B         V
    2 0.278163 11.747800 11.048400  9.8499000
    3 0.318852 11.351400 10.709200  9.5412000
    4 0.335466 11.202800 10.581300  9.424100
    5 0.351598 11.057200 10.457800  9.311900
%a logAge=8.477121
# EEP     Mass         U         B         V
    2 0.212681 12.572800 11.744600 10.476800
    3 0.290489 11.618800 10.938200  9.749800
    4 0.320389 11.334800 10.694700  9.527700
    5 0.335518 11.203400 10.582200  9.425100

%s [Fe/H]=-2.000000    [alpha/Fe]=0.000000    l/Hp=1.938000    Y=0.245300
%a logAge=8.397940
# EEP     Mass         U         B         V
    2 0.297801 12.158900 11.256200  9.965500
    3 0.335484 11.803100 10.943200  9.682100
    4 0.338823 11.767400 10.912600  9.654600
    5 0.355097 11.597400 10.764600  9.520300
%a logAge=8.477121

# EEP     Mass         U         B         V
    2 0.251276 12.662100 11.691800 10.354800
    3 0.317207 11.977800 11.095900  9.820500
    4 0.335075 11.807600 10.947700  9.686600
    5 0.337718 11.786200 10.929600  9.670500
|]
</pre>
</div>


<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #BA36A5;">&lt;&lt;</span>test spec finder<span style="color: #BA36A5;">&gt;&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">module</span> <span style="color: #6434A3;">MainSequenceSpec</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Conduit</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Attoparsec.ByteString</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.ByteString</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">ByteString</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Conduit.Lzma</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Conduit.Attoparsec</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Either</span> <span style="color: #707183;">(</span>isRight<span style="color: #707183;">)</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Test.Hspec</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">MainSequenceModel</span>

<span style="color: #006699;">loadAndLex</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">String</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">IO</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">loadAndLex</span> p <span style="color: #BA36A5;">=</span>
  runConduitRes <span style="color: #707183;">(</span> sourceFile p
               <span style="color: #BA36A5;">.|</span> decompress <span style="color: #6434A3;">Nothing</span>
               <span style="color: #BA36A5;">.|</span> lexModel
               <span style="color: #BA36A5;">.|</span> parseModel
               <span style="color: #BA36A5;">.|</span> sinkNull <span style="color: #707183;">)</span>


<span style="color: #006699;">main</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">IO</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">main</span> <span style="color: #BA36A5;">=</span> hspec spec


<span style="color: #006699;">spec</span> <span style="color: #BA36A5;">=</span> heavyTests


<span style="color: #006699;">heavyTests</span> <span style="color: #BA36A5;">=</span> describe <span style="color: #008000;">"heavy"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
  describe <span style="color: #008000;">"Loading Tests"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
    describe <span style="color: #008000;">"Old DSED"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      it <span style="color: #008000;">"loads successfully"</span> <span style="color: #BA36A5;">$</span>
        loadAndLex <span style="color: #008000;">"mainSequence/dsed_old.model.xz"</span>
    describe <span style="color: #008000;">"New DSED"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      it <span style="color: #008000;">"loads successfully"</span> <span style="color: #BA36A5;">$</span>
        loadAndLex <span style="color: #008000;">"mainSequence/dsed_new.model.xz"</span>
    describe <span style="color: #008000;">"Yale 2018"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      it <span style="color: #008000;">"loads successfully"</span> <span style="color: #BA36A5;">$</span>
        loadAndLex <span style="color: #008000;">"mainSequence/yale_2018.model.xz"</span>
    describe <span style="color: #008000;">"PARSEC"</span> <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
      it <span style="color: #008000;">"loads successfully"</span> <span style="color: #BA36A5;">$</span>
        loadAndLex <span style="color: #008000;">"mainSequence/PARSEC.model.xz"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Main</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Conduit</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Either</span> <span style="color: #707183;">(</span>lefts<span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Set</span>  <span style="color: #707183;">(</span><span style="color: #6434A3;">Set</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Text</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Text</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Options.Applicative</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Text.Printf</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Paths</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">MainSequenceModel</span>


<span style="color: #006699;">loadModels</span> <span style="color: #BA36A5;">::</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">HasModelPath</span> p<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=&gt;</span> p <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">IO</span> <span style="color: #707183;">[</span><span style="color: #6434A3;">Either</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Double</span>, <span style="color: #6434A3;">Double</span>, <span style="color: #909183;">[</span><span style="color: #709870;">(</span><span style="color: #6434A3;">Double</span>, <span style="color: #6434A3;">Int</span><span style="color: #709870;">)</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #709870;">[</span><span style="color: #6434A3;">Text</span><span style="color: #709870;">]</span>, <span style="color: #6434A3;">Double</span>, <span style="color: #6434A3;">Double</span><span style="color: #909183;">)</span>, <span style="color: #6434A3;">Set</span> <span style="color: #6434A3;">Age</span><span style="color: #7388D6;">)</span><span style="color: #707183;">]</span>
<span style="color: #006699;">loadModels</span> model <span style="color: #BA36A5;">=</span> runConduitRes <span style="color: #BA36A5;">$</span> loadModel <span style="color: #BA36A5;">.|</span> sinkList
  <span style="color: #0000FF;">where</span> loadModel <span style="color: #BA36A5;">=</span> sourceFile <span style="color: #707183;">(</span>modelPath model <span style="color: #008000;">""</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">.|</span> lexModel <span style="color: #BA36A5;">.|</span> parseModel <span style="color: #BA36A5;">.|</span> mapC checkEeps

<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">ModelFile</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">MkModelFile</span> <span style="color: #707183;">{</span> unModelFile <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">String</span> <span style="color: #707183;">}</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">HasModelPath</span> <span style="color: #6434A3;">ModelFile</span> <span style="color: #0000FF;">where</span>
  modelPath a <span style="color: #0000FF;">_</span> <span style="color: #BA36A5;">=</span> unModelFile a

<span style="color: #006699;">main</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">IO</span> <span style="color: #707183;">()</span>
<span style="color: #006699;">main</span> <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span> options <span style="color: #BA36A5;">&lt;-</span> execParser opts
          model <span style="color: #BA36A5;">&lt;-</span> loadModels options
          putStr <span style="color: #008000;">"Parsed model successfully"</span>

          <span style="color: #0000FF;">let</span> leftEeps <span style="color: #BA36A5;">=</span> lefts model

          <span style="color: #0000FF;">if</span> null leftEeps
             <span style="color: #0000FF;">then</span> putStrLn <span style="color: #008000;">""</span>
             <span style="color: #0000FF;">else</span> printLeftEeps leftEeps
  <span style="color: #0000FF;">where</span>
    opts <span style="color: #BA36A5;">=</span> info <span style="color: #707183;">(</span>option <span style="color: #7388D6;">(</span>maybeReader <span style="color: #909183;">(</span><span style="color: #6434A3;">Just</span> <span style="color: #BA36A5;">.</span> <span style="color: #6434A3;">MkModelFile</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>long <span style="color: #008000;">"modelFile"</span> <span style="color: #BA36A5;">&lt;&gt;</span> help <span style="color: #008000;">"Specify model archive"</span><span style="color: #7388D6;">)</span> <span style="color: #BA36A5;">&lt;**&gt;</span> helper<span style="color: #707183;">)</span>
      <span style="color: #707183;">(</span> fullDesc
     <span style="color: #BA36A5;">&lt;&gt;</span> progDesc <span style="color: #008000;">"Generate an isochrone from the models based on cluster parameters"</span><span style="color: #707183;">)</span>
    printLeftEeps eeps <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span>
        putStr <span style="color: #BA36A5;">.</span> unlines <span style="color: #BA36A5;">.</span> <span style="color: #707183;">(</span><span style="color: #008000;">"; however, at least the following EEPS are missing:"</span> <span style="color: #6434A3;">:</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">$</span> concatMap go eeps
        putStrLn <span style="color: #008000;">"\nOnly the first missing EEP for each age is printed."</span>
      <span style="color: #0000FF;">where</span> go <span style="color: #707183;">(</span>feh, y, as<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">let</span> header <span style="color: #BA36A5;">=</span> printf <span style="color: #008000;">"\n  [Fe/H] = %.2f, Y = %.2f"</span> feh y
                                  ages   <span style="color: #BA36A5;">=</span> map <span style="color: #707183;">(</span>uncurry <span style="color: #7388D6;">(</span>printf <span style="color: #008000;">"    Age = %.2f, EEP = %d"</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> as
                              <span style="color: #0000FF;">in</span> header <span style="color: #6434A3;">:</span> ages
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# LANGUAGE TypeApplications, OverloadedStrings #-}</span>
<span style="color: #0000FF;">module</span> <span style="color: #6434A3;">MainSequenceModel</span> <span style="color: #0000FF;">where</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Conduit</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Control.Exception</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Exception</span>, throw<span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Control.Monad</span> <span style="color: #707183;">(</span>liftM2, when<span style="color: #707183;">)</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Attoparsec.ByteString</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Attoparsec.ByteString.Char8</span> <span style="color: #707183;">(</span>isHorizontalSpace, isEndOfLine, double, decimal, char<span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.ByteString</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">ByteString</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Either</span> <span style="color: #707183;">(</span>isLeft, lefts<span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Text</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Text</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Text.Encoding</span> <span style="color: #707183;">(</span>decodeUtf8<span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Conduit.Attoparsec</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Ord</span> <span style="color: #707183;">(</span>comparing<span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Set</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Set</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.Vector.Unboxed</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Vector</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Attoparsec.ByteString.Char8</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">AP</span>
<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Set</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">S</span>
<span style="color: #0000FF;">import</span> <span style="color: #0000FF;">qualified</span> <span style="color: #6434A3;">Data.Vector.Unboxed</span> <span style="color: #0000FF;">as</span> <span style="color: #6434A3;">V</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Text.Printf</span>

<span style="color: #0000FF;">import</span> <span style="color: #6434A3;">Data.List</span> <span style="color: #707183;">(</span>intersperse<span style="color: #707183;">)</span>


<span style="color: #0000FF;">data</span> <span style="color: #6434A3;">MSModelException</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">LexException</span>         <span style="color: #707183;">[</span><span style="color: #6434A3;">String</span><span style="color: #707183;">]</span> <span style="color: #6434A3;">Position</span>
                      <span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">ParseException</span>       <span style="color: #6434A3;">PositionRange</span>
                      <span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">FilterCountException</span> <span style="color: #6434A3;">PositionRange</span> <span style="color: #6434A3;">Int</span> <span style="color: #6434A3;">Int</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Exception</span> <span style="color: #6434A3;">MSModelException</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Show</span> <span style="color: #6434A3;">MSModelException</span> <span style="color: #0000FF;">where</span>
  showsPrec <span style="color: #0000FF;">_</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">LexException</span> context <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Position</span> line col <span style="color: #0000FF;">_</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span>
    showString <span style="color: #BA36A5;">$</span> printf <span style="color: #008000;">"Failed to lex main sequence model at line %d, column %d\nContext: %s"</span>
                     line col <span style="color: #BA36A5;">$</span> concat <span style="color: #BA36A5;">$</span> intersperse <span style="color: #008000;">" &gt; "</span> context
  showsPrec <span style="color: #0000FF;">_</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">ParseException</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">PositionRange</span> <span style="color: #909183;">(</span><span style="color: #6434A3;">Position</span> line <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span><span style="color: #909183;">)</span> <span style="color: #0000FF;">_</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span>
    showString <span style="color: #BA36A5;">$</span> printf <span style="color: #008000;">"Illegal lexeme in main sequence model on line %d"</span> line
  showsPrec <span style="color: #0000FF;">_</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">FilterCountException</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">PositionRange</span> <span style="color: #909183;">(</span><span style="color: #6434A3;">Position</span> line <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span><span style="color: #909183;">)</span> <span style="color: #0000FF;">_</span><span style="color: #7388D6;">)</span> nFilters eepFilters<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span>
    showString <span style="color: #BA36A5;">$</span> printf <span style="color: #008000;">"Incorrect number of filters on line %d. Expected %d, found %d."</span> line nFilters eepFilters


<span style="color: #0000FF;">data</span> <span style="color: #6434A3;">MSModelFormat</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Filters</span> <span style="color: #707183;">[</span><span style="color: #6434A3;">Text</span><span style="color: #707183;">]</span>
                   <span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">SectionHeader</span> <span style="color: #6434A3;">Double</span> <span style="color: #6434A3;">Double</span> <span style="color: #6434A3;">Double</span> <span style="color: #6434A3;">Double</span>
                   <span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">AgeHeader</span> <span style="color: #6434A3;">Double</span>
                   <span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">EEP</span> <span style="color: #6434A3;">Int</span> <span style="color: #6434A3;">Double</span> <span style="color: #707183;">[</span><span style="color: #6434A3;">Double</span><span style="color: #707183;">]</span>
                   <span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">Comment</span> <span style="color: #6434A3;">Text</span>
                   <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Show</span>, <span style="color: #6434A3;">Eq</span><span style="color: #707183;">)</span>


<span style="color: #006699;">isFilters</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Filters</span> <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">True</span>
<span style="color: #006699;">isFilters</span> <span style="color: #0000FF;">_</span>           <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">False</span>

<span style="color: #006699;">isComment</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Comment</span> <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">True</span>
<span style="color: #006699;">isComment</span> <span style="color: #0000FF;">_</span>           <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">False</span>


<span style="color: #006699;">separator</span> <span style="color: #BA36A5;">=</span> satisfy isHorizontalSpace <span style="color: #BA36A5;">*&gt;</span> skipWhile isHorizontalSpace <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"required spacing"</span>


<span style="color: #006699;">endOfLine</span> <span style="color: #BA36A5;">=</span> AP.endOfLine <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"end of line"</span>


<span style="color: #006699;">parseFilters</span> <span style="color: #BA36A5;">=</span>
  <span style="color: #0000FF;">let</span> parser <span style="color: #BA36A5;">=</span> many1 <span style="color: #707183;">(</span>satisfy isHorizontalSpace <span style="color: #BA36A5;">*&gt;</span> takeWhile1 <span style="color: #7388D6;">(</span>not <span style="color: #BA36A5;">.</span> liftM2 <span style="color: #909183;">(</span><span style="color: #BA36A5;">||</span><span style="color: #909183;">)</span> isHorizontalSpace isEndOfLine<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">&lt;*</span> endOfLine
  <span style="color: #0000FF;">in</span> <span style="color: #6434A3;">Filters</span> <span style="color: #BA36A5;">.</span> map decodeUtf8 <span style="color: #BA36A5;">&lt;$&gt;</span> parser <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"Filters"</span>


<span style="color: #006699;">parseComment</span> <span style="color: #BA36A5;">=</span>
  <span style="color: #0000FF;">let</span> parser <span style="color: #BA36A5;">=</span> skipWhile isHorizontalSpace <span style="color: #BA36A5;">*&gt;</span> takeTill isEndOfLine <span style="color: #BA36A5;">&lt;*</span> endOfLine
  <span style="color: #0000FF;">in</span> <span style="color: #6434A3;">Comment</span> <span style="color: #BA36A5;">.</span> decodeUtf8 <span style="color: #BA36A5;">&lt;$&gt;</span> parser <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"Comment"</span>


<span style="color: #006699;">parseEmptyLine</span> <span style="color: #BA36A5;">::</span> <span style="color: #6434A3;">Parser</span> <span style="color: #6434A3;">MSModelFormat</span>
<span style="color: #006699;">parseEmptyLine</span> <span style="color: #BA36A5;">=</span> pure <span style="color: #707183;">(</span><span style="color: #6434A3;">Comment</span> <span style="color: #008000;">""</span><span style="color: #707183;">)</span>


<span style="color: #006699;">taggedDouble</span> t <span style="color: #BA36A5;">=</span> separator <span style="color: #BA36A5;">*&gt;</span> string t <span style="color: #BA36A5;">*&gt;</span> double


<span style="color: #006699;">parseHeader</span> <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span>
  a <span style="color: #BA36A5;">&lt;-</span> eitherP <span style="color: #008000;">"a"</span> <span style="color: #707183;">(</span>eitherP <span style="color: #008000;">"s"</span> <span style="color: #008000;">"f"</span><span style="color: #707183;">)</span>
  <span style="color: #0000FF;">case</span> a <span style="color: #0000FF;">of</span>
    <span style="color: #6434A3;">Left</span> <span style="color: #0000FF;">_</span> <span style="color: #BA36A5;">-&gt;</span> parseAgeHeader
    <span style="color: #6434A3;">Right</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Left</span> <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> parseSectionHeader
    <span style="color: #6434A3;">Right</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Right</span> <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> parseFilters

<span style="color: #006699;">parseSectionHeader</span> <span style="color: #BA36A5;">=</span>
  <span style="color: #0000FF;">let</span> parser <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">SectionHeader</span> <span style="color: #BA36A5;">&lt;$&gt;</span> feh
                             <span style="color: #BA36A5;">&lt;*&gt;</span> alphaFe
                             <span style="color: #BA36A5;">&lt;*&gt;</span> lHp
                             <span style="color: #BA36A5;">&lt;*&gt;</span> y
                             <span style="color: #BA36A5;">&lt;*</span>  endOfLine

  <span style="color: #0000FF;">in</span> parser <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"Section header"</span>
     <span style="color: #0000FF;">where</span> feh <span style="color: #BA36A5;">=</span> taggedDouble <span style="color: #008000;">"[Fe/H]="</span> <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"[Fe/H]"</span>
           alphaFe <span style="color: #BA36A5;">=</span> taggedDouble <span style="color: #008000;">"[alpha/Fe]="</span>  <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"[alpha/Fe]"</span>
           lHp <span style="color: #BA36A5;">=</span> taggedDouble <span style="color: #008000;">"l/Hp="</span> <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"l/Hp"</span>
           y <span style="color: #BA36A5;">=</span> taggedDouble <span style="color: #008000;">"Y="</span> <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"Y"</span>


<span style="color: #006699;">parseAgeHeader</span> <span style="color: #BA36A5;">=</span>
  <span style="color: #0000FF;">let</span> parser <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">AgeHeader</span> <span style="color: #BA36A5;">&lt;$&gt;</span> logAge <span style="color: #BA36A5;">&lt;*</span> endOfLine
  <span style="color: #0000FF;">in</span> parser <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"Age header"</span>
     <span style="color: #0000FF;">where</span> logAge <span style="color: #BA36A5;">=</span> taggedDouble <span style="color: #008000;">"logAge="</span> <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"logAge"</span>


<span style="color: #006699;">parseEEP</span> <span style="color: #BA36A5;">=</span>
  <span style="color: #0000FF;">let</span> parser <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">EEP</span> <span style="color: #BA36A5;">&lt;$&gt;</span> <span style="color: #707183;">(</span>skipWhile isHorizontalSpace <span style="color: #BA36A5;">*&gt;</span> decimal <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"EEP"</span><span style="color: #707183;">)</span>
                   <span style="color: #BA36A5;">&lt;*&gt;</span> <span style="color: #707183;">(</span>separator <span style="color: #BA36A5;">*&gt;</span> double <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"Mass"</span><span style="color: #707183;">)</span>
                   <span style="color: #BA36A5;">&lt;*&gt;</span> <span style="color: #707183;">(</span>many1 <span style="color: #7388D6;">(</span>separator <span style="color: #BA36A5;">*&gt;</span> double<span style="color: #7388D6;">)</span> <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"Filters"</span><span style="color: #707183;">)</span>
                   <span style="color: #BA36A5;">&lt;*</span>  endOfLine
  <span style="color: #0000FF;">in</span> parser <span style="color: #BA36A5;">&lt;?&gt;</span> <span style="color: #008000;">"EEP"</span>


<span style="color: #036A07;">-- | Lex a Main Sequence model</span>
<span style="color: #036A07;">--</span>
<span style="color: #036A07;">-- Strange goings-on with eitherP here are to force the parser to make choices early</span>
<span style="color: #036A07;">-- This is strictly necessary to get useful error messages, and has a slight performance boost (over choose) as a bonus</span>
<span style="color: #006699;">lexModel</span> <span style="color: #BA36A5;">::</span>
  <span style="color: #6434A3;">Monad</span> m <span style="color: #BA36A5;">=&gt;</span> <span style="color: #6434A3;">ConduitT</span>
    <span style="color: #6434A3;">ByteString</span>
    <span style="color: #707183;">(</span><span style="color: #6434A3;">Either</span> <span style="color: #6434A3;">ParseError</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">PositionRange</span>, <span style="color: #6434A3;">MSModelFormat</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
    m
    <span style="color: #707183;">()</span>
<span style="color: #006699;">lexModel</span> <span style="color: #BA36A5;">=</span> conduitParserEither <span style="color: #BA36A5;">$</span> <span style="color: #0000FF;">do</span>
  c <span style="color: #BA36A5;">&lt;-</span> eitherP <span style="color: #707183;">(</span>char <span style="color: #008000;">'%'</span><span style="color: #707183;">)</span> <span style="color: #707183;">(</span>eitherP <span style="color: #7388D6;">(</span>eitherP <span style="color: #909183;">(</span>char <span style="color: #008000;">'#'</span><span style="color: #909183;">)</span> <span style="color: #909183;">(</span>char <span style="color: #008000;">'\n'</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">(</span>pure <span style="color: #6434A3;">True</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
  <span style="color: #0000FF;">case</span> c <span style="color: #0000FF;">of</span>
    <span style="color: #6434A3;">Right</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Right</span> <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> parseEEP
    <span style="color: #6434A3;">Left</span> <span style="color: #0000FF;">_</span> <span style="color: #BA36A5;">-&gt;</span> parseHeader
    <span style="color: #6434A3;">Right</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Left</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Left</span> <span style="color: #0000FF;">_</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> parseComment
    <span style="color: #6434A3;">Right</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Left</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Right</span> <span style="color: #0000FF;">_</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> parseEmptyLine



<span style="color: #0000FF;">data</span> <span style="color: #6434A3;">Age</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Age</span> <span style="color: #BA36A5;">!</span><span style="color: #6434A3;">Double</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Vector</span> <span style="color: #6434A3;">Int</span><span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Vector</span> <span style="color: #6434A3;">Double</span><span style="color: #707183;">)</span> <span style="color: #707183;">[</span><span style="color: #6434A3;">Vector</span> <span style="color: #6434A3;">Double</span><span style="color: #707183;">]</span> <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Show</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Ord</span> <span style="color: #6434A3;">Age</span> <span style="color: #0000FF;">where</span>
  compare <span style="color: #BA36A5;">=</span> comparing <span style="color: #707183;">(</span><span style="color: #BA36A5;">\</span><span style="color: #7388D6;">(</span><span style="color: #6434A3;">Age</span> a <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span><span style="color: #7388D6;">)</span> <span style="color: #BA36A5;">-&gt;</span> a<span style="color: #707183;">)</span>

<span style="color: #0000FF;">newtype</span> <span style="color: #6434A3;">PrettyAge</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">PrettyAge</span> <span style="color: #6434A3;">Age</span>
  <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Eq</span>, <span style="color: #6434A3;">Ord</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">Show</span> <span style="color: #6434A3;">PrettyAge</span> <span style="color: #0000FF;">where</span>
  showsPrec <span style="color: #0000FF;">_</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">PrettyAge</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Age</span> a <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> shows a


<span style="color: #006699;">checkEeps</span> <span style="color: #BA36A5;">::</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span><span style="color: #909183;">[</span><span style="color: #6434A3;">Text</span><span style="color: #909183;">]</span>, <span style="color: #6434A3;">Double</span>, <span style="color: #6434A3;">Double</span><span style="color: #7388D6;">)</span>, <span style="color: #6434A3;">Set</span> <span style="color: #6434A3;">Age</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">Either</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Double</span>, <span style="color: #6434A3;">Double</span>, <span style="color: #7388D6;">[</span><span style="color: #909183;">(</span><span style="color: #6434A3;">Double</span>, <span style="color: #6434A3;">Int</span><span style="color: #909183;">)</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span> <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span><span style="color: #909183;">[</span><span style="color: #6434A3;">Text</span><span style="color: #909183;">]</span>, <span style="color: #6434A3;">Double</span>, <span style="color: #6434A3;">Double</span><span style="color: #7388D6;">)</span>, <span style="color: #6434A3;">Set</span> <span style="color: #6434A3;">Age</span><span style="color: #707183;">)</span>
<span style="color: #006699;">checkEeps</span> a<span style="color: #BA36A5;">@</span><span style="color: #707183;">(</span><span style="color: #7388D6;">(</span><span style="color: #0000FF;">_</span>, feh, y<span style="color: #7388D6;">)</span>, ages<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span>
  <span style="color: #0000FF;">let</span> leftEeps <span style="color: #BA36A5;">=</span> S.filter isLeft <span style="color: #BA36A5;">$</span> S.map eepsAreConsecutive ages
  <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">if</span> S.null leftEeps
        <span style="color: #0000FF;">then</span> <span style="color: #6434A3;">Right</span> a
        <span style="color: #0000FF;">else</span> <span style="color: #6434A3;">Left</span> <span style="color: #707183;">(</span>feh, y, lefts <span style="color: #BA36A5;">.</span> S.toList <span style="color: #BA36A5;">$</span> leftEeps<span style="color: #707183;">)</span>


<span style="color: #006699;">eepsAreConsecutive</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Age</span> age eeps <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> go
  <span style="color: #0000FF;">where</span> go <span style="color: #BA36A5;">|</span> V.null eeps <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">Right</span> <span style="color: #707183;">(</span><span style="color: #BA36A5;">-</span>1<span style="color: #707183;">)</span>
           <span style="color: #BA36A5;">|</span> otherwise   <span style="color: #BA36A5;">=</span> V.foldl <span style="color: #707183;">(</span><span style="color: #BA36A5;">\</span>b a <span style="color: #BA36A5;">-&gt;</span> <span style="color: #0000FF;">case</span> b <span style="color: #0000FF;">of</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Left</span> <span style="color: #0000FF;">_</span><span style="color: #7388D6;">)</span>  <span style="color: #BA36A5;">-&gt;</span> b
                                                      <span style="color: #7388D6;">(</span><span style="color: #6434A3;">Right</span> v<span style="color: #7388D6;">)</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span>v <span style="color: #BA36A5;">==</span> a<span style="color: #7388D6;">)</span>
                                                                     <span style="color: #0000FF;">then</span> <span style="color: #6434A3;">Right</span> <span style="color: #7388D6;">(</span>succ v<span style="color: #7388D6;">)</span>
                                                                     <span style="color: #0000FF;">else</span> <span style="color: #6434A3;">Left</span> <span style="color: #7388D6;">(</span>age, v<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
                                   <span style="color: #707183;">(</span><span style="color: #6434A3;">Right</span> <span style="color: #BA36A5;">$</span> V.head eeps<span style="color: #707183;">)</span>
                                   eeps


<span style="color: #006699;">parseModel</span> <span style="color: #BA36A5;">::</span>
  <span style="color: #6434A3;">Monad</span> m <span style="color: #BA36A5;">=&gt;</span> <span style="color: #6434A3;">ConduitT</span>
    <span style="color: #707183;">(</span><span style="color: #6434A3;">Either</span> <span style="color: #6434A3;">ParseError</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">PositionRange</span>, <span style="color: #6434A3;">MSModelFormat</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
    <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span><span style="color: #909183;">[</span><span style="color: #6434A3;">Text</span><span style="color: #909183;">]</span>, <span style="color: #6434A3;">Double</span>, <span style="color: #6434A3;">Double</span><span style="color: #7388D6;">)</span>, <span style="color: #6434A3;">Set</span> <span style="color: #6434A3;">Age</span><span style="color: #707183;">)</span>
    m
    <span style="color: #707183;">()</span>
<span style="color: #006699;">parseModel</span> <span style="color: #BA36A5;">=</span>
  mapC handleError <span style="color: #BA36A5;">.|</span> filterC <span style="color: #707183;">(</span>not <span style="color: #BA36A5;">.</span> isComment <span style="color: #BA36A5;">.</span> snd<span style="color: #707183;">)</span> <span style="color: #BA36A5;">.|</span> unpack
  <span style="color: #0000FF;">where</span> handleError <span style="color: #707183;">(</span><span style="color: #6434A3;">Left</span> p<span style="color: #BA36A5;">@</span><span style="color: #7388D6;">(</span><span style="color: #6434A3;">ParseError</span> context <span style="color: #0000FF;">_</span> pos<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span>
          throw <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">LexException</span> context pos
        handleError <span style="color: #707183;">(</span><span style="color: #6434A3;">Left</span> <span style="color: #6434A3;">DivergentParser</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> error <span style="color: #008000;">"Divergent Parser"</span>
        handleError <span style="color: #707183;">(</span><span style="color: #6434A3;">Right</span> r<span style="color: #707183;">)</span> <span style="color: #BA36A5;">=</span> r

        unpack <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span>
          filters <span style="color: #BA36A5;">&lt;-</span> concat <span style="color: #BA36A5;">&lt;$&gt;</span> <span style="color: #707183;">(</span>header <span style="color: #BA36A5;">.|</span> sinkList<span style="color: #707183;">)</span>

          <span style="color: #0000FF;">let</span> nFilters <span style="color: #BA36A5;">=</span> length filters
              go <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span>
                next <span style="color: #BA36A5;">&lt;-</span> await
                <span style="color: #0000FF;">case</span> next <span style="color: #0000FF;">of</span>
                  <span style="color: #6434A3;">Nothing</span> <span style="color: #BA36A5;">-&gt;</span> return <span style="color: #707183;">()</span>
                  <span style="color: #6434A3;">Just</span> <span style="color: #707183;">(</span><span style="color: #0000FF;">_</span>, <span style="color: #6434A3;">SectionHeader</span> feh <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span> y<span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> section nFilters <span style="color: #707183;">(</span>filters, feh, y<span style="color: #707183;">)</span> <span style="color: #BA36A5;">&gt;&gt;</span> go
                  <span style="color: #0000FF;">_</span> <span style="color: #BA36A5;">-&gt;</span> go
          go

        header <span style="color: #BA36A5;">=</span>
          <span style="color: #0000FF;">let</span> go <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span>
                next <span style="color: #BA36A5;">&lt;-</span> await
                <span style="color: #0000FF;">case</span> next <span style="color: #0000FF;">of</span>
                  <span style="color: #6434A3;">Just</span> <span style="color: #707183;">(</span><span style="color: #0000FF;">_</span>, <span style="color: #6434A3;">Filters</span> fs<span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> yield fs <span style="color: #BA36A5;">&gt;&gt;</span> go
                  <span style="color: #6434A3;">Just</span> l               <span style="color: #BA36A5;">-&gt;</span> leftover l
                  <span style="color: #6434A3;">Nothing</span>              <span style="color: #BA36A5;">-&gt;</span> return <span style="color: #707183;">()</span>
          <span style="color: #0000FF;">in</span> go

        section nFilters sectionHeader <span style="color: #BA36A5;">=</span>
          <span style="color: #0000FF;">let</span> go ages <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span>
                next <span style="color: #BA36A5;">&lt;-</span> await
                <span style="color: #0000FF;">case</span> next <span style="color: #0000FF;">of</span>
                  <span style="color: #6434A3;">Just</span> <span style="color: #707183;">(</span><span style="color: #0000FF;">_</span>, <span style="color: #6434A3;">AgeHeader</span> a<span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #0000FF;">do</span>
                    na <span style="color: #BA36A5;">&lt;-</span> age nFilters a
                    go <span style="color: #BA36A5;">$</span> na <span style="color: #BA36A5;">`S.insert`</span> ages

                  <span style="color: #6434A3;">Just</span> l<span style="color: #BA36A5;">@</span><span style="color: #707183;">(</span><span style="color: #0000FF;">_</span>, <span style="color: #6434A3;">SectionHeader</span> <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> doYield ages <span style="color: #BA36A5;">&gt;&gt;</span> leftover l
                  <span style="color: #6434A3;">Just</span> <span style="color: #707183;">(</span>pos, <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span>                     <span style="color: #BA36A5;">-&gt;</span> throw <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">ParseException</span> pos
                  <span style="color: #6434A3;">Nothing</span>                           <span style="color: #BA36A5;">-&gt;</span> doYield ages
          <span style="color: #0000FF;">in</span> go S.empty
            <span style="color: #0000FF;">where</span> doYield ages <span style="color: #BA36A5;">=</span> yield <span style="color: #707183;">(</span>sectionHeader, ages<span style="color: #707183;">)</span>


        age nFilters a <span style="color: #BA36A5;">=</span>
          <span style="color: #0000FF;">let</span> go eeps masses fs <span style="color: #BA36A5;">=</span> <span style="color: #0000FF;">do</span>
                next <span style="color: #BA36A5;">&lt;-</span> await
                <span style="color: #0000FF;">case</span> next <span style="color: #0000FF;">of</span>
                  <span style="color: #6434A3;">Just</span> <span style="color: #707183;">(</span>pos, <span style="color: #6434A3;">EEP</span> eep mass filters<span style="color: #707183;">)</span>  <span style="color: #BA36A5;">-&gt;</span> <span style="color: #0000FF;">do</span>
                    <span style="color: #0000FF;">let</span> eepFilters <span style="color: #BA36A5;">=</span> length filters

                    when <span style="color: #707183;">(</span>eepFilters <span style="color: #BA36A5;">/=</span> nFilters<span style="color: #707183;">)</span> <span style="color: #BA36A5;">$</span> throw <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">FilterCountException</span> pos nFilters eepFilters

                    go <span style="color: #707183;">(</span>eeps <span style="color: #BA36A5;">`V.snoc`</span> eep<span style="color: #707183;">)</span> <span style="color: #707183;">(</span>masses <span style="color: #BA36A5;">`V.snoc`</span> mass<span style="color: #707183;">)</span> <span style="color: #BA36A5;">$</span> zipWith V.snoc fs filters

                  <span style="color: #6434A3;">Just</span> l<span style="color: #BA36A5;">@</span><span style="color: #707183;">(</span><span style="color: #0000FF;">_</span>, <span style="color: #6434A3;">AgeHeader</span> <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span>           <span style="color: #BA36A5;">-&gt;</span> leftover l <span style="color: #BA36A5;">&gt;&gt;</span> doReturn eeps masses fs
                  <span style="color: #6434A3;">Just</span> l<span style="color: #BA36A5;">@</span><span style="color: #707183;">(</span><span style="color: #0000FF;">_</span>, <span style="color: #6434A3;">SectionHeader</span> <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span> <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span> <span style="color: #BA36A5;">-&gt;</span> leftover l <span style="color: #BA36A5;">&gt;&gt;</span> doReturn eeps masses fs
                  <span style="color: #6434A3;">Just</span> <span style="color: #707183;">(</span>pos, <span style="color: #0000FF;">_</span><span style="color: #707183;">)</span>                     <span style="color: #BA36A5;">-&gt;</span> throw <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">ParseException</span> pos
                  <span style="color: #6434A3;">Nothing</span>                           <span style="color: #BA36A5;">-&gt;</span> doReturn eeps masses fs
          <span style="color: #0000FF;">in</span> go V.empty V.empty <span style="color: #BA36A5;">$</span> replicate nFilters <span style="color: #707183;">(</span>V.empty <span style="color: #BA36A5;">@</span><span style="color: #6434A3;">Double</span><span style="color: #707183;">)</span>
            <span style="color: #0000FF;">where</span> doReturn eeps masses fs <span style="color: #BA36A5;">=</span> return <span style="color: #BA36A5;">$</span> <span style="color: #6434A3;">Age</span> a eeps masses fs
</pre>
</div>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #0000FF;">module</span> <span style="color: #6434A3;">Paths</span> <span style="color: #0000FF;">where</span>


<span style="color: #0000FF;">data</span> <span style="color: #6434A3;">MSModel</span> <span style="color: #BA36A5;">=</span> <span style="color: #6434A3;">OldDsed</span> <span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">NewDsed</span> <span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">Yale2018</span> <span style="color: #BA36A5;">|</span> <span style="color: #6434A3;">Parsec</span>
             <span style="color: #0000FF;">deriving</span> <span style="color: #707183;">(</span><span style="color: #6434A3;">Read</span>, <span style="color: #6434A3;">Show</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">HasModelPath</span> a <span style="color: #0000FF;">where</span>
  modelPath <span style="color: #BA36A5;">::</span> a <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">FilePath</span> <span style="color: #BA36A5;">-&gt;</span> <span style="color: #6434A3;">FilePath</span>

<span style="color: #0000FF;">instance</span> <span style="color: #6434A3;">HasModelPath</span> <span style="color: #6434A3;">MSModel</span> <span style="color: #0000FF;">where</span>
  modelPath <span style="color: #6434A3;">OldDsed</span>  base <span style="color: #BA36A5;">=</span> base <span style="color: #BA36A5;">++</span> <span style="color: #008000;">"mainSequence/dsed_old.model.xz"</span>
  modelPath <span style="color: #6434A3;">NewDsed</span>  base <span style="color: #BA36A5;">=</span> base <span style="color: #BA36A5;">++</span> <span style="color: #008000;">"mainSequence/dsed_new.model.xz"</span>
  modelPath <span style="color: #6434A3;">Parsec</span>   base <span style="color: #BA36A5;">=</span> base <span style="color: #BA36A5;">++</span> <span style="color: #008000;">"mainSequence/PARSEC.model.xz"</span>
  modelPath <span style="color: #6434A3;">Yale2018</span> base <span style="color: #BA36A5;">=</span> base <span style="color: #BA36A5;">++</span> <span style="color: #008000;">"mainSequence/yale_2018.model.xz"</span>
</pre>
</div>
</div>

<div id="outline-container-org1e40c85" class="outline-3">
<h3 id="org1e40c85"><span class="section-number-3">2.1.</span> Artifacts</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">name</span>: BayesianStellarEvolution-Models
<span style="color: #BA36A5;">category</span>: application
<span style="color: #BA36A5;">author</span>: Elliot Robinson
<span style="color: #BA36A5;">maintainer</span>: elliot.robinson@rgoptech.com
<span style="color: #BA36A5;">copyright</span>: <span style="color: #008000;">'2019'</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">license:</span>
<span style="color: #BA36A5;">github</span>: BayesianStellarEvolution/BayesianStellarEvolution

<span style="color: #BA36A5;">default-extensions</span>:
  - OverloadedStrings

<span style="color: #BA36A5;">library</span>:
  <span style="color: #BA36A5;">source-dirs</span>: src

  <span style="color: #BA36A5;">exposed-modules</span>:
    - MainSequenceModel
    - Paths

  <span style="color: #BA36A5;">dependencies</span>:
    - base &gt;=4.10 &amp;&amp; &lt;5
    - attoparsec
    - bytestring
    - conduit
    - conduit-extra
    - containers
    - lzma-conduit
    - text
    - vector

<span style="color: #BA36A5;">executables</span>:
  <span style="color: #BA36A5;">testModelFile</span>:
    <span style="color: #BA36A5;">main</span>: Main.hs
    <span style="color: #BA36A5;">source-dirs</span>: testModelFile

    <span style="color: #BA36A5;">dependencies</span>:
      - base
      - BayesianStellarEvolution-Models
      - optparse-applicative
      - conduit
      - containers
      - text

<span style="color: #BA36A5;">tests</span>:
  <span style="color: #BA36A5;">model-tests</span>:
    <span style="color: #BA36A5;">main</span>: Spec.hs
    <span style="color: #BA36A5;">source-dirs</span>: test

    <span style="color: #BA36A5;">ghc-options</span>:
      - -rtsopts

    <span style="color: #BA36A5;">dependencies</span>:
      - base
      - BayesianStellarEvolution-Models
      - attoparsec
      - bytestring
      - conduit
      - conduit-extra
      - hspec
      - lzma-conduit
      - QuickCheck
      - raw-strings-qq
      - vector
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org098841d" class="outline-2">
<h2 id="org098841d"><span class="section-number-2">3.</span> Global Artifacts</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org327f546" class="outline-3">
<h3 id="org327f546"><span class="section-number-3">3.1.</span> Stack config</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">resolver</span>: lts-18.28

<span style="color: #BA36A5;">packages</span>:
  - base
  - models

<span style="color: #BA36A5;">extra-deps</span>:
  - lzma-clib-5.2.2
</pre>
</div>
</div>
</div>

<div id="outline-container-orge834616" class="outline-3">
<h3 id="orge834616"><span class="section-number-3">3.2.</span> GitHub README</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-markdown"><span style="color: #7F7F7F;"># </span><span style="color: #3C3C3C; background-color: #F0F0F0; font-size: 130%; font-weight: bold; text-decoration: overline;">Bayesian Analysis of Stellar Evolution</span>
<span style="color: #7F7F7F;">## </span><span style="color: #123555; background-color: #E5F4FB; font-weight: bold; text-decoration: overline;">Prerequisites</span>
<span style="color: #7F7F7F;">### </span><span style="color: #005522; background-color: #EFFFEF; font-weight: bold;">Required</span>
<span style="color: #7F7F7F;">#### </span><span style="color: #EA6300; font-weight: bold;">Stack</span>

Installation instructions at <span style="color: #7F7F7F;">[</span><span style="color: #006DAF;">stack's README</span><span style="color: #7F7F7F;">](</span><span style="color: #006DAF; text-decoration: underline;">https://docs.haskellstack.org/en/stable/README/</span><span style="color: #7F7F7F;">)</span>.

<span style="color: #7F7F7F;">#### </span><span style="color: #EA6300; font-weight: bold;">XZ Utils (aka liblzma) development files</span>

On Fedora (or other RPM-based platforms)

<span style="color: #7F7F7F;">```</span>
<span style="background-color: #FFFFE0;">sudo yum install xz-devel</span>
<span style="color: #7F7F7F;">```</span>

On Mac OS X with Homebrew:

<span style="color: #7F7F7F;">```</span>
<span style="background-color: #FFFFE0;">brew install xz</span>
<span style="color: #7F7F7F;">```</span>

On Ubuntu (or other apt-based platforms):

<span style="color: #7F7F7F;">```</span>
<span style="background-color: #FFFFE0;">sudo apt install liblzma-dev</span>
<span style="color: #7F7F7F;">```</span>

<span style="color: #7F7F7F;">#### </span><span style="color: #EA6300; font-weight: bold;">zlib development files</span>

On Fedora (or other RPM-based platforms)

<span style="color: #7F7F7F;">```</span>
<span style="background-color: #FFFFE0;">sudo yum install zlib-devel</span>
<span style="color: #7F7F7F;">```</span>

On Mac OS X with Homebrew:

<span style="color: #7F7F7F;">```</span>
<span style="background-color: #FFFFE0;">brew install zlib</span>
<span style="color: #7F7F7F;">```</span>

On Ubuntu (or other apt-based platforms):

<span style="color: #7F7F7F;">```</span>
<span style="background-color: #FFFFE0;">sudo apt install zlib1g-dev</span>
<span style="color: #7F7F7F;">```</span>

<span style="color: #7F7F7F;">### </span><span style="color: #005522; background-color: #EFFFEF; font-weight: bold;">Recommended</span>
<span style="color: #7F7F7F;">#### </span><span style="color: #EA6300; font-weight: bold;">Homebrew (Mac OS X only)</span>

You can install Homebrew from the command line 

<span style="color: #7F7F7F;">```</span>
<span style="background-color: #FFFFE0;">ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" &lt; /dev/null 2&gt; /dev/null</span>
<span style="color: #7F7F7F;">```</span>

<span style="color: #7F7F7F;">## </span><span style="color: #123555; background-color: #E5F4FB; font-weight: bold; text-decoration: overline;">Building the executables</span>

Download the project, open a terminal in the base directory (the one containing <span style="color: #7F7F7F;">`</span><span style="color: #006400; background-color: #FDFFF7;">stack.yaml</span><span style="color: #7F7F7F;">`</span>), then simply run <span style="color: #7F7F7F;">`</span><span style="color: #006400; background-color: #FDFFF7;">stack build</span><span style="color: #7F7F7F;">`</span>.

You can install the applications in a user-local directory with <span style="color: #7F7F7F;">`</span><span style="color: #006400; background-color: #FDFFF7;">stack install</span><span style="color: #7F7F7F;">`</span>, or run them from anywhere inside the project directory using <span style="color: #7F7F7F;">`</span><span style="color: #006400; background-color: #FDFFF7;">stack exec &lt;executable name&gt;</span><span style="color: #7F7F7F;">`</span>.

<span style="color: #7F7F7F;">## </span><span style="color: #123555; background-color: #E5F4FB; font-weight: bold; text-decoration: overline;">Executables</span>

Help is available for each executable by running it with the <span style="color: #7F7F7F;">`</span><span style="color: #006400; background-color: #FDFFF7;">--help</span><span style="color: #7F7F7F;">`</span> flag.

|Name|Description|
|-|-|
|makeIsochrone|Given cluster parameters, generates an isochrone corresponding to those parameters|
|testModelFile|Given a path to an uncompressed model file, attempts to parse that file|
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgea26e35" class="outline-2">
<h2 id="orgea26e35"><span class="section-number-2">4.</span> Templates</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #808080;">{-# OPTIONS_GHC -F -pgmF hspec-discover #-}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Elliot Robinson</p>
<p class="date">Created: 2024-06-02 Sun 14:42</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
